<!DOCTYPE html><html class=2xl:text-[20px] dir=ltr lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Arduino Internals — What's behind the magic? — The Tavern</title><meta content=index,follow name=robots /><meta content="The Arduino ecosystem changed the world of DIY electronics, let's take a look under the hood to figure out how that happened." name=description /><meta content=summary_large_image name=twitter:card /><meta content="Arduino Internals — What's behind the magic?" property=og:title /><meta content="The Arduino ecosystem changed the world of DIY electronics, let's take a look under the hood to figure out how that happened." property=og:description /><meta content=https://vtavernier.github.io/pr-preview/pr-7/posts/arduino-internals-whats-behind-the-magic/ property=og:url /><meta content=article property=og:type /><meta content=https://vtavernier.github.io/pr-preview/pr-7/_astro/arduino-01.ecc1c3ec.jpg property=og:image /><meta content="Arduino Internals — What's behind the magic?" property=og:image:alt /><link href=https://vtavernier.github.io/pr-preview/pr-7/posts/arduino-internals-whats-behind-the-magic/ rel=canonical /><style is:global>:root{--aw-font-sans:'InterVariable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:rgb(89 30 100);--aw-color-secondary:rgb(94 30 100);--aw-color-accent:rgb(100 59 40);--aw-color-text-page:rgb(39 17 39);--aw-color-text-muted:rgb(97 75 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content=9T4KIucFxDdjqi0gdKxvMbVSluLphiFhgBc3iCSAKqk name=google-site-verification><link href=/pr-preview/pr-7/favicon.ico rel="shortcut icon"><link href=/pr-preview/pr-7/favicon.svg rel=icon type=image/svg+xml><link href=/pr-preview/pr-7/favicon.svg rel=mask-icon color=#8D46E7><link href=/pr-preview/pr-7/_astro/index.08ff0bc7.css rel=stylesheet /><link href=/pr-preview/pr-7/_astro/index.03b33478.css rel=stylesheet /><script type=module>const t=document.createElement("script"),a=document.querySelector("#utterances-container"),e=a.attributes;Object.entries({src:"https://utteranc.es/client.js",repo:e["data-repo"].value,"issue-term":e["data-issue-term"].value,label:e["data-label"].value,theme:e["data-theme"].value,crossorigin:"anonymous"}).forEach((([e,a])=>{t.setAttribute(e,a)})),a?.appendChild(t)</script></head><body class="dark:text-zinc-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="mx-auto w-full duration-100 ease-in flex-none sticky top-0 transition-all z-40" id=header><div class="mx-auto max-w-7xl md:flex md:justify-between md:px-4 md:py-3.5 px-3 py-3 w-full"><div class="flex justify-between"><a href=/pr-preview/pr-7/ class="items-center flex"><span class="ml-2 dark:text-white font-bold md:text-xl self-center text-2xl text-gray-900 whitespace-nowrap"><svg viewBox="0 0 68.792 68.792" class=inline height=32 width=32><g style=fill:#2f3136;stroke:#8aa2d3;stroke-width:1.98438><path d="M30.088 56.162V24.233h13.89v31.93ZM6.068 20.085V6.195h63.183l-13.89 13.89Z" transform="translate(-3.264 3.218)"></path></g></svg> The Tavern</span></a><div class="items-center flex md:hidden"><button class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-800 ml-1.5 text-gray-500 transition" aria-label="Toggle Menu" data-aw-toggle-menu type=button><svg viewBox="0 0 24 24" class="h-6 w-6" astro-icon=tabler:menu preserveAspectRatio="xMidYMid meet" xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><g fill=none class=icon-tabler stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M4 8h16"/><path d="M4 16h16"/></g></svg></button></div></div><nav aria-label="Main navigation" class="items-center hidden md:flex dark:text-zinc-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 text-xl w-full"><li class=""><a href=/pr-preview/pr-7/posts/ class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-gray-900 px-4 py-3 transition">Blog</a></li><li class=""><a href=https://github.com/stars/vtavernier/lists/star-showcase class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-gray-900 px-4 py-3 transition">Projects</a></li><li class=""><a href=/pr-preview/pr-7/research/ class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-gray-900 px-4 py-3 transition">Research</a></li><li class=""><a href=/pr-preview/pr-7/about/ class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-gray-900 px-4 py-3 transition">About me</a></li></ul></nav><div class="items-center flex md:mb-0 md:self-center"><div class="items-center hidden md:flex"><a href=/pr-preview/pr-7/rss.xml class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-gray-700 hover:bg-gray-100" aria-label="RSS Feed"><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon=tabler:rss><g fill=none class=icon-tabler stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><circle cx=5 cy=19 r=1 /><path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"/></g></svg></a></div></div></div></header><main><section class="mx-auto lg:py-20 py-8 sm:py-16"><article><header class=""><div class="mx-auto sm:px-6 max-w-3xl px-4 flex flex-col justify-between mb-2 mt-0 sm:flex-row sm:items-center"><p><svg viewBox="0 0 24 24" class="inline-block h-4 w-4 -mt-0.5 dark:text-gray-400" astro-icon=tabler:clock><g fill=none class=icon-tabler stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><circle cx=12 cy=12 r=9 /><path d="M12 7v5l3 3"/></g></svg> <time datetime="Mon Apr 26 2021 00:00:00 GMT+0000 (Coordinated Universal Time)">Apr 26, 2021</time> · <a href=/pr-preview/pr-7/category/embedded-programming/ class="capitalize hover:underline">embedded programming</a></p></div><h1 class="mx-auto sm:px-6 max-w-3xl px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">Arduino Internals — What&#39;s behind the magic?</h1><p class="mx-auto sm:px-6 max-w-3xl px-4 dark:text-zinc-400 mb-8 md:text-2xl mt-4 text-muted text-xl">Embedded programming abstraction layers and reverse engineering shenanigans.</p><picture><source sizes="(max-width: 900px) 400px, 900px" srcset="/pr-preview/pr-7/_astro/arduino-01.ecc1c3ec_1tI9Ed.avif 400w,/pr-preview/pr-7/_astro/arduino-01.ecc1c3ec_ZmBguu.avif 900w" type=image/avif><source sizes="(max-width: 900px) 400px, 900px" srcset="/pr-preview/pr-7/_astro/arduino-01.ecc1c3ec_2d3XBY.webp 400w,/pr-preview/pr-7/_astro/arduino-01.ecc1c3ec_lIxsh.webp 900w" type=image/webp><source sizes="(max-width: 900px) 400px, 900px" srcset="/pr-preview/pr-7/_astro/arduino-01.ecc1c3ec_dvIjy.jpg 400w,/pr-preview/pr-7/_astro/arduino-01.ecc1c3ec_Z2sexRK.jpg 900w" type=image/jpeg><img alt="The Arduino ecosystem changed the world of DIY electronics, let's take a look under the hood to figure out how that happened." class="mx-auto bg-gray-400 dark:bg-zinc-700 lg:max-w-6xl max-w-full mb-6 sm:rounded-md" decoding=async height=506 loading=eager src=/pr-preview/pr-7/_astro/arduino-01.ecc1c3ec_Z2sexRK.jpg width=900></picture></header><div class="mx-auto sm:px-6 max-w-3xl px-6 mt-8 dark:prose-a:text-purple-400 dark:prose-headings:text-zinc-300 dark:prose-invert prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow-lg prose-md"><p>Arduino is an open-source software and hardware platform tailored for electronics beginners and enthusiasts alike. Since the early models’ releases (Arduino Diecimila in 2007 and Duemilanove in 2009), they have become ubiquitous to the point that “an Arduino” is often used as a synonym for “a microcontroller”, and have been used in countless projects by makers around the world.</p><p></p><figure class="flex flex-col"><img alt="Arduino Duemilanove 2009b" class=mx-auto decoding=async height=284 loading=lazy src=/pr-preview/pr-7/_astro/Arduino_Duemilanove_2009b.1ba6d6f7_6eenF.jpg width=400><figcaption class=mx-auto><p>An Arduino Duemilanove. The first Arduino I actually programmed. Source: <a href=https://commons.wikimedia.org/wiki/File:Arduino_Duemilanove_2009b.jpg>Wikipedia</a></p></figcaption></figure><p></p><p>What this project actually achieved is simplifying microcontroller programming to the extreme, replacing obscure datasheet diving and reference implementation diagrams dissection with intuitive function calls <em>mostly</em> portable across the entire official product range. The “hello world” of electronics, the blinking LED was simplified from this:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#6272a4>// Compile with:       avr-gcc -mmcu=atmega328p -DF_CPU=16000000L</span></span>
<span class=line><span style=color:#6272a4>// Create binary with: avr-objcopy -O ihex -R .eeprom a.out a.hex</span></span>
<span class=line><span style=color:#6272a4>// Upload with:        avrdude -p atmega328p -c arduino -P /dev/ttyUSB0 -b 57600 -D -U flash:w:a.hex:i</span></span>
<span class=line><span style=color:#6272a4>// Only works on the Arduino Uno series, with a 16MHz µC</span></span>
<span class=line><span style=color:#ff79c6>#include</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>&lt;</span><span style=color:#f1fa8c>avr/io.h</span><span style=color:#e9f284>&gt;</span></span>
<span class=line><span style=color:#ff79c6>#include</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>&lt;</span><span style=color:#f1fa8c>util/delay.h</span><span style=color:#e9f284>&gt;</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>int</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>main</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#6272a4>  // Set the LED&#39;s pin to output</span></span>
<span class=line><span style=color:#f8f8f2>  DDRB </span><span style=color:#ff79c6>|=</span><span style=color:#f8f8f2> (</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f8f8f2> PB5);</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#ff79c6>while</span><span style=color:#f8f8f2> (</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>    // Toggle the LED pin state</span></span>
<span class=line><span style=color:#f8f8f2>    PORTB </span><span style=color:#ff79c6>^=</span><span style=color:#f8f8f2> (</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f8f8f2> PB5);</span></span>
<span class=line><span style=color:#6272a4>    // Wait</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>_delay_ms</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>1000</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>  }</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>To this:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#6272a4>// In the Arduino IDE, click &quot;upload&quot;</span></span>
<span class=line><span style=color:#6272a4>// Portable across all Arduinos which have a built-in LED</span></span>
<span class=line><span style=color:#ff79c6>#include</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>&lt;</span><span style=color:#f1fa8c>Arduino.h</span><span style=color:#e9f284>&gt;</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>setup</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#6272a4>  // Set the LED&#39;s pin to output</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>pinMode</span><span style=color:#f8f8f2>(LED_BUILTIN, OUTPUT);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>loop</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#6272a4>  // Switch on the LED</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>digitalWrite</span><span style=color:#f8f8f2>(LED_BUILTIN, HIGH);</span></span>
<span class=line><span style=color:#6272a4>  // Wait</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>delay</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>1000</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#6272a4>  // Switch off the LED</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>digitalWrite</span><span style=color:#f8f8f2>(LED_BUILTIN, LOW);</span></span>
<span class=line><span style=color:#6272a4>  // Wait</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>delay</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>1000</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>Of course, this is just scratching the surface, since opening up the world of microcontrollers to the masses also sparked a lot of open-source development, and many libraries can be used to interact with the “shields”, add-ons to the base Arduino board: <a href=https://store.arduino.cc/arduino-motor-shield-rev3>motor drivers</a>, <a href=https://store.arduino.cc/arduino-ethernet-shield-2>Ethernet interfaces</a>, <a href=https://store.arduino.cc/arduino-mkr-imu-shield>IMUs</a> and countless others.</p><p>Various <a href=https://www.amazon.com/ELEGOO-Project-Tutorial-Controller-Projects/dp/B01D8KOZF4>starter kits</a> can also be used if you want to prototype your own circuits with an Arduino Uno compatible board and some standard components, such as an ultrasonic distance reader, humidity and temperature sensor, 7-segment displays, etc.</p><p>The USB (data and power!) connection on most boards means these are just plug and play: buy an Arduino board from your favorite reseller, and you can program it from any desktop or laptop PC.</p><p>Recently however, a lot of “Arduino-compatible” boards started appearing on the market, such as the hugely popular ESP8266 from Espressif Systems, available on the original <a href=https://en.wikipedia.org/wiki/NodeMCU>NodeMCU</a>, but also in Arduino-Uno <a href=https://www.amazon.com/ARCELI-ESP8266-Development-Compatible-Arduino/dp/B07J2QKNHB/ >footprints</a>, with built-in Wi-Fi capabilities, much more processing power as well as large storage.</p><p></p><figure class="flex flex-col"><img alt="WeMos D1" class=mx-auto decoding=async height=307 loading=lazy src=/pr-preview/pr-7/_astro/WeMos_D1.75cfbcf8_ZvwLaB.jpg width=399><figcaption class=mx-auto><p>WeMos D1, one of the many ESP8266 boards</p></figcaption></figure><p></p><p>Even though those were not initially programmable from the Arduino IDE, the Arduino community added support for these as they became one of the most go-to choices for IoT projects over the recent years.</p><p>But with such a wide variety of hardware, how does the Arduino platform provide an <em>almost</em> seamless development experience on AVR, ARM, Xtensa and many other architectures?</p><p>Experienced embedded developers know this means installing various toolchains for cross-compiling, fiddling with linker scripts to get the right memory layout for your specific board revision, and a bunch of other boring stuff we won’t get to in this article. Instead, we’ll be focusing on the software side: what’s exactly behind <code>#include &lt;Arduino.h&gt;</code> on a few select platforms, and why we would need to care about it.</p><blockquote><p>All the examples in this article were developed using <a href=https://platformio.org/ >PlatformIO</a>, which I highly recommend instead of the Arduino IDE. Although the recent releases have made huge progress, I prefer the versatility of my text editor (with <a href=https://github.com/MaskRay/ccls>ccls</a> completion) and compiling/uploading with a simple <code>pio run -t upload</code> command.</p></blockquote><h1 id=arduino-framework-architecture>Arduino framework architecture</h1><p>For most software projects, the go-to way for getting information about library internals would be hitting the reference manual online. In the case of Arduino, it is located at <a href=https://www.arduino.cc/reference/en>https://www.arduino.cc/reference/en</a>. However, it is surprisingly succint: function signatures included in the documentation don’t even show the arguments’ type<sup><a href=#user-content-fn-arduino-reference-no-signature aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-arduino-reference-no-signature>1</a></sup>.</p><p>For a beginner, using the C++ language, whose type conversions are a minefield<sup><a href=#user-content-fn-cpp-minefield aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-cpp-minefield>2</a></sup>, on a target that doesn’t support debugging (and where buffer overflows result in usually very funny looking output on your serial port monitor) can lead to many headaches and hours of painful trial and error.</p><p>This reference was also written for the <em>original</em> Arduino boards, i.e. the AVR-based ones. The most notable example is the <a href=https://www.arduino.cc/reference/en/language/variables/utilities/progmem/ >PROGMEM</a> variable modifier, which is only available on AVR targets. Trying to use it on non-AVR targets results in a compile-error, unless your code detects it is being compiled for a non-AVR target.</p><p>The reference documentation also mixes <a href=https://www.arduino.cc/reference/en/#functions>standard library functions</a>, <a href=https://www.arduino.cc/reference/en/#variables>plain datatypes and complex ones</a><sup><a href=#user-content-fn-string-datatype aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-string-datatype>3</a></sup>, <a href=https://www.arduino.cc/reference/en/#structure>Arduino program structure and C++ language details</a> on a single page.</p><p><strong>To be absolutely clear:</strong> I am not saying this is a bad thing. This documentation has been written with the clear intent of being a one-stop point, easy to approach for a beginner, and should be sufficient for hobbyists to get started, until they are more at ease with electronics and/or software development — and it accomplishes this goal rather well. But for more advanced users, it is clearly lacking information about design choices and platform differences — a notable issue when promoting Arduino code as platform-independent.</p><p>My goal when writing this article was to share with the world the process I went through to unearth some differences I noticed when working with various boards (ESP8266, Arduino Nano 33 BLE, ATTiny85-based Digispark and others). So let’s get started!</p><h2 id=whats-behind-arduinoh-exactly>What’s behind <code>Arduino.h</code> exactly?</h2><p>Using a new board in the Arduino IDE is as simple as downloading the right <em>core</em> through the <em>board manager</em>. We can look around starting from a basic sketch to peek at the internals of what this <em>core</em> really is. Starting with <code>Arduino.h</code>, which all Arduino code should <code>#include</code> to access the standard library functions described in the reference documentation, using an IDE with code completion<sup><a href=#user-content-fn-vim-platformio-ccls aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-vim-platformio-ccls>4</a></sup>, we can just ask the editor to open the header file under our cursor and follow the include graph.</p><p>This will bring up this version of <code>Arduino.h</code> from the core installation path. When building for an AVR board such as the Arduino Uno, this will bring up <a href=https://github.com/arduino/ArduinoCore-avr/blob/master/cores/arduino/Arduino.h>$AVR_CORE/cores/arduino/Arduino.h</a>, which already teaches us a lot:</p><ul><li>There’s all the constants in the documentation, as <code>#define</code>s, and some functions which are actually implemented as macros (e.g. <code>min</code> and <code>max</code>).</li><li>Gated behind <code>__cplusplus</code>, includes for some types defined by Wiring, the predecessor of the Arduino framework, itself based on Processing. The main one being <code>WString.h</code>, defining the <code>String</code> type.</li><li>Some board-specific stuff, like including USB API support or hardware serial support depending on preprocessor definitions.</li><li>A final include for <code>pins_arduino.h</code>, which contains mappings from Arduino pin numbers (0-13 as what’s passed to <code>digitalWrite</code>) to physical microcontroller pins (<code>PORTB</code>, <code>PORTC</code> registers and others). This one is stored in the <code>$AVR_CORE/variants/$VARIANT</code> folder: depending on the current board, the right <code>-I</code> flag will be passed to the compiler to include mappings for the target, for example the Arduino Mega (<code>$VARIANT = mega</code>), or Uno (<code>$VARIANT = standard</code>).</li></ul><p>Noting the dependencies while following along, we can draw a (partial so it fits in a blog post) include graph between the different components of this core:</p><figure><div class=mermaid>flowchart TB sketch[Blink.ino] --&gt; arduino_h subgraph avr_std[AVR Toolchain] avr_io[avr/io.h] avr_pgmspace[avr/pgmspace.h] avr_stdio[stdio.h] end subgraph avr_core[Arduino AVR Core] subgraph cores/arduino arduino_h[Arduino.h] arduino_h --&gt; wstring_h[WString.h] arduino_h --&gt; print_h[Print.h] arduino_h --&gt; avr_pgmspace print_h --&gt; avr_stdio wstring_h --&gt; avr_pgmspace end arduino_h -- -I flag --&gt; arduino_pins_h_standard arduino_h -.-&gt; arduino_pins_h_others arduino_h --&gt; avr_io subgraph variants subgraph standard arduino_pins_h_standard[arduino_pins.h] ---&gt; avr_io arduino_pins_h_standard ---&gt; avr_pgmspace end subgraph others[...] arduino_pins_h_others[arduino_pins.h] ---&gt; avr_io arduino_pins_h_others ---&gt; avr_pgmspace end end end</div><figcaption>Arduino AVR partial include graph</figcaption></figure><p>This <code>Arduino.h</code> is already hardware-specific, even if most of it is hardware-independent. Its definitions follow what we can see in the reference documentation, but it is definitely <strong>not</strong> portable. It is however shared for all boards using the same architecture, and maintained by the same entity. In this case, this is the original AVR core, and it is even available on GitHub, in a sensible location: <a href=https://github.com/arduino/ArduinoCore-avr>https://github.com/arduino/ArduinoCore-avr</a>.</p><p>Let’s explore it a bit more: the core also contains the actual implementations of functions from the Arduino framework, which is what we’re after. To keep this short, we will look at <code>digitalWrite</code>, about which there is already a lot to say.</p><h3 id=arduinos-digitalwrite-on-atmels-avr-platform>Arduino’s <code>digitalWrite</code> on Atmel’s AVR platform</h3><p>Using our trusty editor and it is <em>go to implementation</em> feature, we can quickly find it in <a href=https://github.com/arduino/ArduinoCore-avr/blob/9f8d27f09f3bbd1da1374b5549a82bda55d45d44/cores/arduino/wiring_digital.c#L138>wiring_digital.c</a>, in all its microcontroller-programming-simplifying glory:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>digitalWrite</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>uint8_t</span><span style=color:#f8f8f2> </span><span style=color:#ffb86c>pin</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>uint8_t</span><span style=color:#f8f8f2> </span><span style=color:#ffb86c>val</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>uint8_t</span><span style=color:#f8f8f2> timer </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>digitalPinToTimer</span><span style=color:#f8f8f2>(pin);</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>uint8_t</span><span style=color:#f8f8f2> bit </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>digitalPinToBitMask</span><span style=color:#f8f8f2>(pin);</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>uint8_t</span><span style=color:#f8f8f2> port </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>digitalPinToPort</span><span style=color:#f8f8f2>(pin);</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>volatile</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>uint8_t</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>out;</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> (port </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> NOT_A_PIN) </span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// If the pin that support PWM output, we need to turn it off</span></span>
<span class=line><span style=color:#6272a4>	// before doing a digital write.</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> (timer </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> NOT_ON_TIMER) </span><span style=color:#50fa7b>turnOffPWM</span><span style=color:#f8f8f2>(timer);</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	out </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>portOutputRegister</span><span style=color:#f8f8f2>(port);</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>uint8_t</span><span style=color:#f8f8f2> oldSREG </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> SREG;</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#50fa7b>cli</span><span style=color:#f8f8f2>();</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> (val </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> LOW) {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>out </span><span style=color:#ff79c6>&amp;=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>~</span><span style=color:#f8f8f2>bit;</span></span>
<span class=line><span style=color:#f8f8f2>	} </span><span style=color:#ff79c6>else</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>out </span><span style=color:#ff79c6>|=</span><span style=color:#f8f8f2> bit;</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	SREG </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> oldSREG;</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>To set the logic level of an output pin, <code>digitalWrite</code> actually does the following:</p><ul><li>Check that the given pin is suitable for digital output (the <code>digitalPinTo*</code> family of functions will return <code>NOT_*</code> sentinel values otherwise)</li><li>Disable hardware PWM on the target pin if it was enabled</li><li>Disable hardware interrupts, set the target value, and then re-enable them</li></ul><p>For a microcontroller running at 16MHz, <code>digitalWrite</code> is a noticeably expensive operation. Indeed, it does:</p><ul><li>3 <code>PROGMEM</code> reads (<code>digitalPinTo*</code> function calls) for <code>timer</code>, <code>bit</code> and <code>port</code>.</li><li>2 branches to validate the pin values. Note that the function fails silently for wrong pin values.</li><li>1 more <code>PROGMEM</code> read for getting the port’s output register from its port number <code>port</code>.<br/><blockquote><p><em>Note: by this point, all the values in the data flow are returned from reading constant arrays in program memory with <code>pgm_read_byte</code>. Even though these values should be constant folded if <code>pin</code> and <code>val</code> are themselves constants, the compiler can’t reason enough yet to perform this optimization. Which means the rest of the operations can’t be optimized for constants.</em></p></blockquote></li><li>Disable interrupts<sup><a href=#user-content-fn-critical-section aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-critical-section>5</a></sup>.</li><li>One last branch to determine if a bit should be cleared or set.</li><li>Apply the bitmask: this is a read-modify-write operation, and thus non-atomic, which requires disabled interrupts for correctness.</li><li>Restore interrupts.</li></ul><p>These multiple levels of indirections are, at the time of writing, <strong>not</strong> optimized away by <code>avr-gcc</code>. The following Arduino sketch (which only uses constants for both the pin and value):</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#ff79c6>#include</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>&lt;</span><span style=color:#f1fa8c>Arduino.h</span><span style=color:#e9f284>&gt;</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>setup</span><span style=color:#f8f8f2>() { </span><span style=color:#50fa7b>pinMode</span><span style=color:#f8f8f2>(LED_BUILTIN, OUTPUT); }</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>loop</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>digitalWrite</span><span style=color:#f8f8f2>(LED_BUILTIN, HIGH);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>digitalWrite</span><span style=color:#f8f8f2>(LED_BUILTIN, LOW);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>Compiles to the following assembly<sup><a href=#user-content-fn-arduino-platformio-optimization aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-arduino-platformio-optimization>6</a></sup>:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#bd93f9>000000e0</span><span style=color:#f8f8f2> &lt;digitalWrite.constprop</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>0</span><span style=color:#f8f8f2>&gt;:</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> # [truncated: 54 instructions for computing timer, bit, port and other checks]</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> #   uint8_t oldSREG = SREG;</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#bd93f9>158</span><span style=color:#f8f8f2>:	9f b7       	</span><span style=color:#ff79c6>in</span><span style=color:#f8f8f2>	r25, </span><span style=color:#bd93f9>0x3f</span><span style=color:#6272a4>	# 63</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> #   cli();</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>15a:</span><span style=color:#f8f8f2>	f8 </span><span style=color:#bd93f9>94</span><span style=color:#f8f8f2>       	</span><span style=color:#ff79c6>cli</span></span>
<span class=line><span style=color:#f8f8f2>  #   </span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> (val == LOW) {</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>15c:</span><span style=color:#f8f8f2>	</span><span style=color:#bd93f9>81</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>11</span><span style=color:#f8f8f2>       	cpse	r24, r1</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>15e:</span><span style=color:#f8f8f2>	</span><span style=color:#bd93f9>04</span><span style=color:#f8f8f2> c0       	rjmp	.+</span><span style=color:#bd93f9>8</span><span style=color:#f8f8f2>      </span><span style=color:#6272a4>	# 0x168 &lt;digitalWrite.constprop.0+0x88&gt;</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> #     *out &amp;= ~bit;</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#bd93f9>160</span><span style=color:#f8f8f2>:	8c </span><span style=color:#bd93f9>91</span><span style=color:#f8f8f2>       	ld	r24, X</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#bd93f9>162</span><span style=color:#f8f8f2>:	</span><span style=color:#bd93f9>20</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>95</span><span style=color:#f8f8f2>       	com	r18</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#bd93f9>164</span><span style=color:#f8f8f2>:	</span><span style=color:#bd93f9>28</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>23</span><span style=color:#f8f8f2>       	</span><span style=color:#ff79c6>and</span><span style=color:#f8f8f2>	r18, r24</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> #   } else {</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#bd93f9>166</span><span style=color:#f8f8f2>:	</span><span style=color:#bd93f9>02</span><span style=color:#f8f8f2> c0       	rjmp	.+</span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>      </span><span style=color:#6272a4>	# 0x16c &lt;digitalWrite.constprop.0+0x8c&gt;</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> #     *out |= bit;</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#bd93f9>168</span><span style=color:#f8f8f2>:	ec </span><span style=color:#bd93f9>91</span><span style=color:#f8f8f2>       	ld	r30, X</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>16a:</span><span style=color:#f8f8f2>	2e 2b       	</span><span style=color:#ff79c6>or</span><span style=color:#f8f8f2>	r18, r30</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>16c:</span><span style=color:#f8f8f2>	2c </span><span style=color:#bd93f9>93</span><span style=color:#f8f8f2>       	</span><span style=color:#f8f8f2;font-weight:700>st</span><span style=color:#f8f8f2>	X, r18</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> #   }</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> #   SREG = oldSREG;</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>16e:</span><span style=color:#f8f8f2>	9f bf       	</span><span style=color:#ff79c6>out</span><span style=color:#f8f8f2>	</span><span style=color:#bd93f9>0x3f</span><span style=color:#f8f8f2>, r25</span><span style=color:#6272a4>	# 63</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> # }</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#bd93f9>170</span><span style=color:#f8f8f2>:	</span><span style=color:#bd93f9>08</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>95</span><span style=color:#f8f8f2>       	</span><span style=color:#ff79c6>ret</span></span>
<span class=line></span>
<span class=line><span style=color:#bd93f9>00000206</span><span style=color:#f8f8f2> &lt;main&gt;:</span></span>
<span class=line><span style=color:#6272a4> # [truncated: Arduino framework initialization]</span></span>
<span class=line><span style=color:#6272a4> # [truncated: inlined call to pinMode(...) ]</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4> # Note: loop is inlined since it is only called from Arduino&#39;s main</span></span>
<span class=line><span style=color:#6272a4> # digitalWrite(LED_BUILTIN, HIGH);</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>2c6:</span><span style=color:#f8f8f2>	</span><span style=color:#bd93f9>81</span><span style=color:#f8f8f2> e0       	ldi	r24, </span><span style=color:#bd93f9>0x01</span><span style=color:#6272a4>	# 1</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>2c8:</span><span style=color:#f8f8f2>	0e </span><span style=color:#bd93f9>94</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>70</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>00</span><span style=color:#f8f8f2> 	</span><span style=color:#ff79c6>call</span><span style=color:#f8f8f2>	</span><span style=color:#bd93f9>0xe0</span><span style=color:#6272a4>	# 0xe0 &lt;digitalWrite.constprop.0&gt;</span></span>
<span class=line><span style=color:#6272a4> # digitalWrite(LED_BUILTIN, LOW);</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>2cc:</span><span style=color:#f8f8f2>	</span><span style=color:#bd93f9>80</span><span style=color:#f8f8f2> e0       	ldi	r24, </span><span style=color:#bd93f9>0x00</span><span style=color:#6272a4>	# 0</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>2ce:</span><span style=color:#f8f8f2>	0e </span><span style=color:#bd93f9>94</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>70</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>00</span><span style=color:#f8f8f2> 	</span><span style=color:#ff79c6>call</span><span style=color:#f8f8f2>	</span><span style=color:#bd93f9>0xe0</span><span style=color:#6272a4>	# 0xe0 &lt;digitalWrite.constprop.0&gt;</span></span>
<span class=line><span style=color:#6272a4> # Note: the following is the Arduino&#39;s while loop around calling loop()</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>2d2:</span><span style=color:#f8f8f2>	</span><span style=color:#bd93f9>20</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>97</span><span style=color:#f8f8f2>       	sbiw	r28, </span><span style=color:#bd93f9>0x00</span><span style=color:#6272a4>	# 0</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#f55;font-weight:700>2d4:</span><span style=color:#f8f8f2>	c1 f3       	breq	.-</span><span style=color:#bd93f9>16</span><span style=color:#f8f8f2>     </span><span style=color:#6272a4>	# 0x2c6 &lt;main+0xc0&gt;</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4> # [truncated: more main code]</span></span></code></pre><p>While its equivalent pure-AVR code:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#ff79c6>#include</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>&lt;</span><span style=color:#f1fa8c>avr/io.h</span><span style=color:#e9f284>&gt;</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>int</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>main</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>  DDRB </span><span style=color:#ff79c6>|=</span><span style=color:#f8f8f2> (</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f8f8f2> PB5);</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#ff79c6>while</span><span style=color:#f8f8f2> (</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>    PORTB </span><span style=color:#ff79c6>|=</span><span style=color:#f8f8f2> (</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f8f8f2> PB5);</span></span>
<span class=line><span style=color:#f8f8f2>    PORTB </span><span style=color:#ff79c6>&amp;=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>~</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f8f8f2> PB5);</span></span>
<span class=line><span style=color:#f8f8f2>  }</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>Compiles to the optimal assembly below (<code>sbi</code> sets a specific bit in a port register, and <code>cbi</code> clears it):</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#bd93f9>00000080</span><span style=color:#f8f8f2> &lt;main&gt;:</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> # DDRB |= (1 &lt;&lt; PB5);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#bd93f9>80</span><span style=color:#f8f8f2>:	</span><span style=color:#bd93f9>25</span><span style=color:#f8f8f2> 9a       	sbi	</span><span style=color:#bd93f9>0x04</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>5</span><span style=color:#6272a4>	# 4</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> # while (1) {</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> # PORTB |= (1 &lt;&lt; PB5);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#bd93f9>82</span><span style=color:#f8f8f2>:	</span><span style=color:#bd93f9>2d</span><span style=color:#f8f8f2> 9a       	sbi	</span><span style=color:#bd93f9>0x05</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>5</span><span style=color:#6272a4>	# 5</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> # PORTB &amp;= ~(1 &lt;&lt; PB5);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#bd93f9>84</span><span style=color:#f8f8f2>:	</span><span style=color:#bd93f9>2d</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>98</span><span style=color:#f8f8f2>       	cbi	</span><span style=color:#bd93f9>0x05</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>5</span><span style=color:#6272a4>	# 5</span></span>
<span class=line><span style=color:#f8f8f2> </span><span style=color:#6272a4> # }</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#bd93f9>86</span><span style=color:#f8f8f2>:	fd cf       	rjmp	.-</span><span style=color:#bd93f9>6</span><span style=color:#f8f8f2>      </span><span style=color:#6272a4>	# 0x82 &lt;main+0x2&gt;</span></span></code></pre><p>Which brings us to the essential question: <strong>is the Arduino framework’s implementation right?</strong></p><p>In a sense, <strong>yes</strong>: it translates user-facing Arduino board pin identifiers to hardware pins under the hood, ensures there are no conflicts with PWM settings, and does update the output register in a correct (atomic) way. <strong>But</strong>, this is a very costly abstraction (67 instructions + function call compared to one <em>single-cycle</em> instruction). If your code does some high-frequency bit banging (every few clock cycles), you won’t be able to use <code>digitalWrite</code>, which is orders of magnitude slower, and has side effects (disabling interrupts temporarily).</p><p>Of course, these abstractions are what make Arduino beginner-friendly, but are limited because of their implementation in C++. A language with more robust compile-time guarantees could reason more efficiently about hardware port usage, and could also compile to the optimal version — but <a href=https://github.com/rust-lang/rust/issues/78260>the Rust backend isn’t there yet</a>.</p><p>More details about this assembly comparison are available on <a href=https://vtavernier.github.io/blog-arduino-internals/ >this page</a>. As an extra comparison point, a proof of concept for a template-based hardware abstraction is included, which compiles to the same optimal assembly as raw AVR code. Please note that the Arduino version also has timer interrupts for maintaining a clock, which explains most of the program size difference — aside from the actual <code>digitalWrite</code> calls.</p><p>Personally, I think these limitations should <em>at least</em> be mentioned in the reference documentation. This wouldn’t overload beginners browsing the function reference for the first time, as long as it is hidden in an expandable “For advanced users” section. This function <span class=tooltip title="Does this call for a part 2 🤔?">isn’t the only one with caveats</span>, and it is likely that large projects using the Arduino platform will encounter more of those — undocumented — limitations and performance/readability trade-offs.</p><h3 id=arduinos-analogwrite-on-the-mbed-framework>Arduino’s <code>analogWrite</code> on the Mbed framework</h3><p>Backtracking a bit, we can look at a core’s implementation for another platform. In this case, the <a href=https://github.com/arduino/ArduinoCore-mbed>ARM Mbed core</a> for Mbed enabled devices. <a href=https://os.mbed.com/ >Mbed</a> is an open-source operating system for IoT applications running on the ARM architecture. The goal of this kind of <em>operating systems</em> is to simplify embedded development for the supported platforms, the same way the Arduino framework simplifies development for the Arduino-enabled boards.</p><p>The <a href=https://store.arduino.cc/arduino-nano-33-ble>Arduino Nano 33 BLE</a> is one example of such a board. Its nRF52840 SoC contains a 32-bit ARM Cortex-M4 CPU running at 64MHz as well as a Bluetooth chip which supports BLE. This is the board we will be using as a target for looking under the hood.</p><p></p><figure class="flex flex-col"><img alt="Arduino Nano 33 BLE" class=mx-auto decoding=async height=300 loading=lazy src=/pr-preview/pr-7/_astro/Arduino_Nano_33_BLE.7720c97b_1RDUJA.jpg width=400><figcaption class=mx-auto><p>Arduino Nano 33 BLE. Source: <a href=https://arduino.cc>arduino.cc</a></p></figcaption></figure><p></p><p>The <code>Arduino.h</code> header is located in the same directory, relative to the Mbed core root, and corresponds roughly to what we saw before for the AVR core: generic Arduino definitions and “hardware”-specific. “Hardware” in quotes since the Mbed framework is already an abstraction layer over the actual processor:</p><figure><div class=mermaid>graph LR sketch[Blink.ino] --&gt; arduino_h subgraph arm_mbed[Arm Mbed] subgraph mbed_target_nrf5x[nrf5X SDK] nrfx_h[nrfx.h] end mbed_h[mbed.h] -.-&gt; nrfx_h end subgraph mbed_core[Arduino Mbed Core] arduino_h[Arduino.h] --&gt; mbed_h end</div><figcaption>Arduino Mbed partial include graph</figcaption></figure><p>In this case, the Arduino core provides:</p><ul><li>An abstraction over the Mbed API, for platform-independence of Arduino code, and to simplify it for beginners</li><li>The hardware pin mappings for the various boards (<em>variants</em>), since Mbed is only responsible for interacting with the CPU</li></ul><p>This can easily be seen by looking at the implementation of, let’s say <code>analogWrite</code> in <a href=https://github.com/arduino/ArduinoCore-mbed/blob/e50ec8aa1b1cd3079566b66b22bf8ded5e253cbb/cores/arduino/wiring_analog.cpp#L45>cores/arduino/wiring_analog.cpp</a>:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#ff79c6>static</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>int</span><span style=color:#f8f8f2> write_resolution </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>8</span><span style=color:#f8f8f2>;</span></span>
<span class=line><span style=color:#6272a4>// [...]</span></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>PinName</span><span style=color:#f8f8f2> </span><span style=color:#ffb86c>pin</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>int</span><span style=color:#f8f8f2> </span><span style=color:#ffb86c>val</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#8be9fd>pin_size_t</span><span style=color:#f8f8f2> idx </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>PinNameToIndex</span><span style=color:#f8f8f2>(pin);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> (idx </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> NOT_A_PIN) {</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(idx, val);</span></span>
<span class=line><span style=color:#f8f8f2>  } </span><span style=color:#ff79c6>else</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>    mbed</span><span style=color:#ff79c6>::</span><span style=color:#f8f8f2>PwmOut</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2> pwm </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6;font-style:italic>new</span><span style=color:#f8f8f2> mbed</span><span style=color:#ff79c6>::</span><span style=color:#50fa7b>PwmOut</span><span style=color:#f8f8f2>(pin);</span></span>
<span class=line><span style=color:#f8f8f2>    pwm</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>period_ms</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>);</span><span style=color:#6272a4> //500Hz</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#ff79c6>float</span><span style=color:#f8f8f2> percent </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> (</span><span style=color:#ff79c6>float</span><span style=color:#f8f8f2>)val</span><span style=color:#ff79c6>/</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>float</span><span style=color:#f8f8f2>)(</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f8f8f2> write_resolution);</span></span>
<span class=line><span style=color:#f8f8f2>    pwm</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>write</span><span style=color:#f8f8f2>(percent);</span></span>
<span class=line><span style=color:#f8f8f2>  }</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>pin_size_t</span><span style=color:#f8f8f2> </span><span style=color:#ffb86c>pin</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>int</span><span style=color:#f8f8f2> </span><span style=color:#ffb86c>val</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> (pin </span><span style=color:#ff79c6>&gt;=</span><span style=color:#f8f8f2> PINS_COUNT) {</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2>;</span></span>
<span class=line><span style=color:#f8f8f2>  }</span></span>
<span class=line><span style=color:#ff79c6>#ifdef</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>DAC</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> (pin </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> DAC) {</span></span>
<span class=line><span style=color:#f8f8f2>      </span><span style=color:#50fa7b>analogWriteDAC</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>digitalPinToPinName</span><span style=color:#f8f8f2>(pin), val);</span></span>
<span class=line><span style=color:#f8f8f2>      </span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2>;</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line><span style=color:#ff79c6>#endif</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#ff79c6>float</span><span style=color:#f8f8f2> percent </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> (</span><span style=color:#ff79c6>float</span><span style=color:#f8f8f2>)val</span><span style=color:#ff79c6>/</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>float</span><span style=color:#f8f8f2>)(</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&lt;&lt;</span><span style=color:#f8f8f2> write_resolution);</span></span>
<span class=line><span style=color:#f8f8f2>  mbed</span><span style=color:#ff79c6>::</span><span style=color:#f8f8f2>PwmOut</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2> pwm </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>digitalPinToPwm</span><span style=color:#f8f8f2>(pin);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> (pwm </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>NULL</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>    pwm </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6;font-style:italic>new</span><span style=color:#f8f8f2> mbed</span><span style=color:#ff79c6>::</span><span style=color:#50fa7b>PwmOut</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>digitalPinToPinName</span><span style=color:#f8f8f2>(pin));</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>digitalPinToPwm</span><span style=color:#f8f8f2>(pin) </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> pwm;</span></span>
<span class=line><span style=color:#f8f8f2>    pwm</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>period_ms</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>);</span><span style=color:#6272a4> //500Hz</span></span>
<span class=line><span style=color:#f8f8f2>  }</span></span>
<span class=line><span style=color:#f8f8f2>  pwm</span><span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>write</span><span style=color:#f8f8f2>(percent);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line><span style=color:#6272a4>// [...]</span></span></code></pre><p>Looking at this implementation:</p><ul><li>The first overload is called if you pass a <code>PinName</code> for the pin number, which is an <code>enum</code> declared by Mbed’s abstraction layer. If the pin exists in the Arduino’s mapping (<code>PinNameToIndex</code>), it is forwarded to the second overload. Otherwise, writing the PWM parameters is delegated to an <code>mbed::PwmOut</code> which is subsequently leaked.</li><li>The second overload is called when passing a raw pin number, which is what Arduino sketches typically do. Skipping over the DAC part, this function sets up a singleton <code>mbed::PwmOut</code> for this pin in a global array somewhere whose mapping is resolved by the <code>digitalPinToPwm</code> macro. This allocation only happens once, the <code>PwmOut</code> object being reused on a subsequent call to <code>analogWrite</code> for the same pin.</li></ul><p>This implementation is correct: since invoking the constructor for a <code>mbed::PwmOut</code> object actually initializes the PWM hardware for the given pin<sup><a href=#user-content-fn-mbed-pwmout-constructor aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-mbed-pwmout-constructor>7</a></sup>, this side effect only appears when the first <code>analogWrite</code> call is issued. Being able to change the PWM frequency would be nice, but it is currently not possible on other platforms either. At least, not through the official Arduino API<sup><a href=#user-content-fn-change-pwm-frequency aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-change-pwm-frequency>8</a></sup>.</p><p>However, both the <a href=https://os.mbed.com/docs/mbed-os/v6.9/apis/pwmout.html>Mbed documentation</a> <strong>and</strong> the <a href=https://www.arduino.cc/reference/en/language/functions/analog-io/analogwrite/ >Arduino documentation</a> fail to mention one major limitation. The Arduino 33 BLE is equipped with a RGB LED connected to pins 22, 23, and 24 for its R, G and B channels respectively. It’s a perfect candidate for PWM to dim the various channels:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#ff79c6>#include</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>&lt;</span><span style=color:#f1fa8c>Arduino.h</span><span style=color:#e9f284>&gt;</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>setup</span><span style=color:#f8f8f2>() {}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>loop</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#ff79c6>auto</span><span style=color:#f8f8f2> now </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>millis</span><span style=color:#f8f8f2>();</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // Set the RGB LED color</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(LEDR, (now </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>100</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>%</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>255</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(LEDG, (now </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>200</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>%</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>255</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(LEDB, (now </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>300</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>%</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>255</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>This sketch works perfectly fine, but is rather limited. In an actual project, you might also be controlling other devices using PWM, which the Arduino Nano 33 BLE is perfectly able to do, since PWM is supported on <a href=https://store.arduino.cc/arduino-nano-33-ble>all digital pins</a>, according to its technical specifications. Maybe we could control some extra pins:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#ff79c6>#include</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>&lt;</span><span style=color:#f1fa8c>Arduino.h</span><span style=color:#e9f284>&gt;</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>setup</span><span style=color:#f8f8f2>() {}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>loop</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#ff79c6>auto</span><span style=color:#f8f8f2> now </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>millis</span><span style=color:#f8f8f2>();</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // Set the RGB LED color</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(LEDR, (now </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>100</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>%</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>255</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(LEDG, (now </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>200</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>%</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>255</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(LEDB, (now </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>300</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>%</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>255</span><span style=color:#f8f8f2>);</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // Added: a red LED on 11, and a green one on 12?</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>11</span><span style=color:#f8f8f2>, (now </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>400</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>%</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>255</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>  </span><span style=color:#50fa7b>analogWrite</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>12</span><span style=color:#f8f8f2>, (now </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>500</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>%</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>255</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>When compiled and uploaded to the board, you don’t get five PWM pins but instead a board that disappears from the USB devices on your computer, blinking its builtin LED in a — rather ominous the first time — Morse code SOS pattern. Before assuming the board burnt-out, I tried the following steps:</p><ul><li>Googling the issue: no significant results at the time to help<sup><a href=#user-content-fn-google-sos-blink aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-google-sos-blink>9</a></sup>.</li><li>Re-uploading the previous code after resetting: works.</li><li>Replacing <code>analogWrite</code> calls with <code>mbed::PwmOut</code> objects: doesn’t work.</li></ul><p>This rules out hardware issues, as well as the Arduino abstraction layer over Mbed. Off to the Mbed source code we go! Note that the core downloaded by the board manager or PlatformIO does not contain the Mbed source code. It’s a rather large project, and as such is distributed in a pre-compiled version:</p><div class="drop-shadow-sm rounded-md tm-output" style=background-color:#282a36;color:var(--tw-prose-pre-code)><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height=14 width=54 xmlns=http://www.w3.org/2000/svg><g fill=none fill-rule=evenodd transform="translate(1 1)"><circle cx=6 cy=6 r=6 fill=#FF5F56 stroke=#E0443E stroke-width=.5></circle><circle cx=26 cy=6 r=6 fill=#FFBD2E stroke=#DEA123 stroke-width=.5></circle><circle cx=46 cy=6 r=6 fill=#27C93F stroke=#1AAB29 stroke-width=.5></circle></g></svg></div><pre class=mt-0 style=background-color:#282a36;color:var(--tw-prose-pre-code)>$ <span style=font-weight:700>find -name *.a</span>
./variants/ARDUINO_NANO33BLE/libs/libmbed.a
./variants/ARDUINO_NANO33BLE/libs/libcc_310_core.a
./variants/ARDUINO_NANO33BLE/libs/libcc_310_trng.a
./variants/ARDUINO_NANO33BLE/libs/libcc_310_ext.a
./variants/PORTENTA_H7_M4/libs/libmbed.a
./variants/PORTENTA_H7_M4/libs/libopenamp.a
./variants/PORTENTA_H7_M7/libs/libmbed.a</pre></div><p>Thankfully, the Mbed source code is available on <a href=https://github.com/ARMmbed/mbed-os>GitHub</a>. Following the dependency chain, we can find the source of our issue:</p><ul><li><code>mbed::PwmOut</code> is declared in <a href=https://github.com/ARMmbed/mbed-os/blob/mbed-os-6.9.0/drivers/include/drivers/PwmOut.h>drivers/include/drivers/PwmOut.h</a>. It references <code>hal/pwmout_api.h</code> which, as the name indicates, is an Hardware Abstraction Layer (HAL) for the <code>PwmOut</code> API.</li><li>The implementation of <code>mbed::PwmOut</code> in <a href=https://github.com/ARMmbed/mbed-os/blob/mbed-os-6.9.0/drivers/source/PwmOut.cpp>drivers/source/PwmOut.cpp</a> confirms this: the class methods call methods from this HAL API in order to change the actual hardware state.</li><li>Looking at <a href=https://github.com/ARMmbed/mbed-os/blob/mbed-os-6.9.0/hal/include/hal/pwmout_api.h>hal/include/hal/pwmout_api.h</a>, the comments mention that the target should implement the methods declared in this file in order to provide PWM output capabilities to the user.</li><li>The CPU on the Arduino Nano 33 BLE is a Nordic nRF52840. The Mbed source code does indeed contain a target for this architecture, in <a href=https://github.com/ARMmbed/mbed-os/tree/mbed-os-6.9.0/targets/TARGET_NORDIC/TARGET_NRF5x>targets/TARGET_NORDIC/TARGET_NRF5x</a>.</li><li>A quick <code>find targets/TARGET_NORDIC/TARGET_NRF5x -name pwmout_api.*</code> reveals the PWM HAL implementation for this target resides in <a href=https://github.com/ARMmbed/mbed-os/blob/mbed-os-6.9.0/targets/TARGET_NORDIC/TARGET_NRF5x/TARGET_NRF52/pwmout_api.c>targets/TARGET_NORDIC/TARGET_NRF5x/TARGET_NRF52/pwmout_api.c</a>. Bingo!</li></ul><p>Skimming through this implementation, the first interesting thing is the <code>nordic_pwm_init</code> function:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#ff79c6>static</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>nordic_pwm_init</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>pwmout_t</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>*</span><span style=color:#ffb86c>obj</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>MBED_ASSERT</span><span style=color:#f8f8f2>(obj);</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    /* Default configuration:</span></span>
<span class=line><span style=color:#6272a4>     * 1 pin per instance, otherwise they would share base count.</span></span>
<span class=line><span style=color:#6272a4>     * 1 MHz clock source to match the 1 us resolution.</span></span>
<span class=line><span style=color:#6272a4>     */</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#8be9fd>nrfx_pwm_config_t</span><span style=color:#f8f8f2> config </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>        .output_pins  </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>            obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>pin,</span></span>
<span class=line><span style=color:#f8f8f2>            NRFX_PWM_PIN_NOT_USED,</span></span>
<span class=line><span style=color:#f8f8f2>            NRFX_PWM_PIN_NOT_USED,</span></span>
<span class=line><span style=color:#f8f8f2>            NRFX_PWM_PIN_NOT_USED,</span></span>
<span class=line><span style=color:#f8f8f2>        },</span></span>
<span class=line><span style=color:#f8f8f2>        .irq_priority </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> PWM_DEFAULT_CONFIG_IRQ_PRIORITY,</span></span>
<span class=line><span style=color:#f8f8f2>        .base_clock   </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> NRF_PWM_CLK_1MHz,</span></span>
<span class=line><span style=color:#f8f8f2>        .count_mode   </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> NRF_PWM_MODE_UP,</span></span>
<span class=line><span style=color:#f8f8f2>        .top_value    </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>period,</span></span>
<span class=line><span style=color:#f8f8f2>        .load_mode    </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> NRF_PWM_LOAD_COMMON,</span></span>
<span class=line><span style=color:#f8f8f2>        .step_mode    </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> NRF_PWM_STEP_AUTO,</span></span>
<span class=line><span style=color:#f8f8f2>    };</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    /* Initialize instance with new configuration. */</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#8be9fd>ret_code_t</span><span style=color:#f8f8f2> result </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>nrfx_pwm_init</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&amp;</span><span style=color:#f8f8f2>nordic_nrf5_pwm_instance[obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>instance],</span></span>
<span class=line><span style=color:#f8f8f2>                                      </span><span style=color:#ff79c6>&amp;</span><span style=color:#f8f8f2>config,</span></span>
<span class=line><span style=color:#f8f8f2>                                      </span><span style=color:#bd93f9>NULL</span><span style=color:#f8f8f2>);</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>MBED_ASSERT</span><span style=color:#f8f8f2>(result </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> NRFX_SUCCESS);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>A couple of things worth noting:</p><ul><li>It only uses one pin out of four in what looks like a configuration structure for PWM (<code>nrfx_pwm_config_t.output_pins</code>).</li><li>Initializing a PWM instance an fail, and is thus checked by the <code>MBED_ASSERT</code> macro. This macro is used multiple times through this implementation. Would this assertion failing trigger the blinking SOS behavior we have encountered?</li></ul><p>Finding out the behavior of this macro is left as an exercise to the reader. But since you are still reading this, you probably quickly found out that a failed assertion leads to an eventual call to <a href=https://github.com/ARMmbed/mbed-os/blob/c73413893fb98aaaeda74513c981ac68adc8645d/platform/source/mbed_board.c#L26>mbed_die</a> which blinks <code>LED1</code> in an SOS pattern indefinitely. Our hypothesis is confirmed!</p><p>If you somehow managed to follow this source-digging carefully, you might have noticed <code>nordic_pwm_init</code> is a <code>static</code> function: it is only a helper function for implementing the HAL, which is later defined in the file. Namely, <a href=https://github.com/ARMmbed/mbed-os/blob/mbed-os-6.9.0/targets/TARGET_NORDIC/TARGET_NRF5x/TARGET_NRF52/pwmout_api.c#L137>pwmout_init</a>:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#ff79c6>void</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>pwmout_init</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>pwmout_t</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>*</span><span style=color:#ffb86c>obj</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd>PinName</span><span style=color:#f8f8f2> </span><span style=color:#ffb86c>pin</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>DEBUG_PRINTF</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>&quot;</span><span style=color:#f1fa8c>pwmout_init: </span><span style=color:#bd93f9>%d</span><span style=color:#ff79c6>\r\n</span><span style=color:#e9f284>&quot;</span><span style=color:#f8f8f2>, pin);</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>MBED_ASSERT</span><span style=color:#f8f8f2>(obj);</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    /* Get hardware instance from pinmap. */</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#ff79c6>int</span><span style=color:#f8f8f2> instance </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>pin_instance_pwm</span><span style=color:#f8f8f2>(pin);</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>MBED_ASSERT</span><span style=color:#f8f8f2>(instance </span><span style=color:#ff79c6>&lt;</span><span style=color:#f8f8f2> (</span><span style=color:#ff79c6>int</span><span style=color:#f8f8f2>)(</span><span style=color:#ff79c6>sizeof</span><span style=color:#f8f8f2>(nordic_nrf5_pwm_instance) </span><span style=color:#ff79c6>/</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>sizeof</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>nrfx_pwm_t</span><span style=color:#f8f8f2>)));</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    /* Populate PWM object with default values. */</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>instance </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> instance;</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>pin </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> pin;</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>pulse </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>;</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>period </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> MAX_PWM_COUNTERTOP;</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>percent </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>;</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>sequence.values.p_common </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&amp;</span><span style=color:#f8f8f2>obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>pulse;</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>sequence.length </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>NRF_PWM_VALUES_LENGTH</span><span style=color:#f8f8f2>(obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>pulse);</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>sequence.repeats </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>;</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>sequence.end_delay </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    /* Set active low logic. */</span></span>
<span class=line><span style=color:#f8f8f2>    obj</span><span style=color:#ff79c6>-&gt;</span><span style=color:#f8f8f2>pulse </span><span style=color:#ff79c6>|=</span><span style=color:#f8f8f2> SEQ_POLARITY_BIT;</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    /* Initialize PWM instance. */</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>nordic_pwm_init</span><span style=color:#f8f8f2>(obj);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>Interestingly enough, this code is very similar to the Arduino implementation of <code>analogWrite</code>. The pin number is mapped to an <em>instance</em> number:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#6272a4>    /* Get hardware instance from pinmap. */</span></span>
<span class=line><span style=color:#f8f8f2>    </span><span style=color:#ff79c6>int</span><span style=color:#f8f8f2> instance </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>pin_instance_pwm</span><span style=color:#f8f8f2>(pin);</span></span></code></pre><p><a href=https://github.com/ARMmbed/mbed-os/blob/c73413893fb98aaaeda74513c981ac68adc8645d/targets/TARGET_NORDIC/TARGET_NRF5x/TARGET_NRF52/pinmap_ex.c#L307>pin_instance_pwm</a> actually allocates hardware PWM instance numbers for the given pin. If no more instances are available, it will return the <code>NC</code> constant to indicate no such instance is available:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#6272a4>/**</span></span>
<span class=line><span style=color:#6272a4> * Brief       Find hardware instance for the provided PWM pin.</span></span>
<span class=line><span style=color:#6272a4> *</span></span>
<span class=line><span style=color:#6272a4> *             The function will search the PeripheralPin map for a pre-allocated</span></span>
<span class=line><span style=color:#6272a4> *             assignment. If none is found the allocation map will be searched</span></span>
<span class=line><span style=color:#6272a4> *             to see if the same pins have been assigned an instance before.</span></span>
<span class=line><span style=color:#6272a4> *</span></span>
<span class=line><span style=color:#6272a4> *             If no assignement is found and there is an empty slot left in the</span></span>
<span class=line><span style=color:#6272a4> *             map, the pins are stored in the map and the hardware instance is</span></span>
<span class=line><span style=color:#6272a4> *             returned.</span></span>
<span class=line><span style=color:#6272a4> *</span></span>
<span class=line><span style=color:#6272a4> *             If no free instances are available, the default instance is returned.</span></span>
<span class=line><span style=color:#6272a4> *</span></span>
<span class=line><span style=color:#6272a4> * Parameter   pwm   pwm pin.</span></span>
<span class=line><span style=color:#6272a4> *</span></span>
<span class=line><span style=color:#6272a4> * Return      Hardware instance associated with provided pins.</span></span>
<span class=line><span style=color:#6272a4> */</span></span>
<span class=line><span style=color:#ff79c6>int</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>pin_instance_pwm</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>PinName</span><span style=color:#f8f8f2> </span><span style=color:#ffb86c>pwm</span><span style=color:#f8f8f2>)</span></span></code></pre><p>Thus, how many instances are there? <a href=https://github.com/ARMmbed/mbed-os/blob/c73413893fb98aaaeda74513c981ac68adc8645d/targets/TARGET_NORDIC/TARGET_NRF5x/TARGET_NRF52/pinmap_ex.c#L281><strong>four</strong>, according to the declaration preceding <code>pin_instance_pwm</code></a>. This means that when <code>pwmout_init</code> runs out of hardware PWM instances, the <a href=https://github.com/ARMmbed/mbed-os/blob/c73413893fb98aaaeda74513c981ac68adc8645d/targets/TARGET_NORDIC/TARGET_NRF5x/TARGET_NRF52/pwmout_api.c#L146>following assertion</a> will fail:</p><pre class=astro-code style=background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word><code><span class=line><span style=color:#f8f8f2>    </span><span style=color:#50fa7b>MBED_ASSERT</span><span style=color:#f8f8f2>(instance </span><span style=color:#ff79c6>&lt;</span><span style=color:#f8f8f2> (</span><span style=color:#ff79c6>int</span><span style=color:#f8f8f2>)(</span><span style=color:#ff79c6>sizeof</span><span style=color:#f8f8f2>(nordic_nrf5_pwm_instance) </span><span style=color:#ff79c6>/</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>sizeof</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>nrfx_pwm_t</span><span style=color:#f8f8f2>)));</span></span></code></pre><p>Which in turn, stops the CPU and blinks the builtin LED in an SOS pattern. <strong>Mystery solved! 🎉</strong></p><blockquote><p>But <strong>hold on</strong>. Why say PWM output is supported on all digital pins if we can only use four of them at the same time?</p></blockquote><p>Well, according to the <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fstruct_nrf52%2Fstruct%2Fnrf52840.html">product specification</a>, the nRF52840 does feature <em>4x four channel pulse width modulator (PWM) unit with EasyDMA</em>. What this actually means is that there are four fully-independent PWM modules (the <em>hardware instances</em> in the code we just studied), each of which can drive four pins. This brings the total of PWM pins to 16, which is much more reasonable as long as you can group them into the four PWM modules available.</p><p>If you spend more time digging through the <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.sdk5.v15.0.0%2Fgroup__nrf__pwm.html&#38;cp=7_5_3_6_9_0_12">Nordic SDK documentation for PWM</a>, you will find out that the 4 pins of a single instance will share the same PWM frequency, but you can still set different duty cycles. ARMed with this knowledge, you may now implement an nRF-specific PWM port that can drive 4 pins at the same time, but only using one hardware instance. See my implementation which resulted from this reverse-engineering at <a href=https://github.com/vtavernier/smart-tps/blob/master/include/nano33ble/nrf_pwm_port.hpp>nrf_pwm_port.hpp</a> and <a href=https://github.com/vtavernier/smart-tps/blob/master/src/nano33ble/nrf_pwm_port.cpp>nrf_pwm_port.cpp</a>.</p><p>This leaves us with a fully-dimmable RGB LED and 3 possible <code>analogWrite</code>-controllable pins. <strong>Problem solved!</strong></p><h1 id=conclusion>Conclusion</h1><p>I wanted to share this reverse-engineering adventure as I think it could be useful for other developers working with the Arduino ecosystem. Most of the discoveries mentioned here are to my knowledge, at the time of writing this article, not documented anywhere.</p><p>To me, even with those hidden caveats, Arduinos are still an excellent platform for beginners and hobbyists. These limitations should not be encountered in <em>most</em> cases, and more experienced developers should be able to work around these issues by reaching for the hardware SDKs directly.</p><p>The only major pain point I had working with Arduino libraries is the strong coupling with the hardware. If you wish to test some of your code on your computer instead of the target board (PlatformIO has a <code>native</code> target just for this), you have to design your code around the fact that <code>Arduino.h</code> is not available for desktop targets, even if most of it is hardware-independent. But we shall go down this rabbit hole another time.</p><p>Until then, happy hacking!</p><section class=footnotes data-footnotes=""><h2 id=footnote-label class=sr-only>Footnotes</h2><ol><li id=user-content-fn-arduino-reference-no-signature><p>See “Syntax” and “Parameters” in <a href=https://www.arduino.cc/reference/en/language/functions/digital-io/digitalwrite/ >https://www.arduino.cc/reference/en/language/functions/digital-io/digitalwrite/</a> <a href=#user-content-fnref-arduino-reference-no-signature class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id=user-content-fn-cpp-minefield><p>Using this <a href=https://en.cppreference.com/w/cpp/language/implicit_conversion>digest version</a> of the C++ standard for implicit conversions, try predicting what passing an <code>int</code> to a function that expects a <code>byte</code> (Arduino-specific definition). Bonus points if you can describe what happens on overflow on the various architectures this code could be run on. <a href=#user-content-fnref-cpp-minefield class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id=user-content-fn-string-datatype><p><code>int</code>, <code>char</code>, <code>float</code> and other built-in data-types are C++ built-ins, supported directly by the target platform and are basically free to create. This isn’t the case of the <code>String</code> type, which allocates memory, an expensive and error-prone operation (running out of heap space overwrites your program’s stack — a “technicality” not mentioned in the documentation). <a href=#user-content-fnref-string-datatype class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id=user-content-fn-vim-platformio-ccls><p>Creating a project with <code>pio init --ide vim</code> will create the necessary files for the <code>ccls</code> language server to provide completion and go-to definition for Arduino code. This what I mainly used for this work. <a href=#user-content-fnref-vim-platformio-ccls class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id=user-content-fn-critical-section><p>On AVR, setting a bit in an output register is an atomic operation (<code>sbi</code> instruction). However, <code>*port |= mask</code> is a <em>read-modify-write</em> operation since <code>mask</code> may set more than one bit and/or not be a constant. By being 3 instructions long, there is a chance an interruption could happen between the <em>read</em> and <em>write</em>, and break the code. Thus, a critical section is required, which equates to temporarily disabling interrupt handling. <a href=#user-content-fnref-critical-section class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id=user-content-fn-arduino-platformio-optimization><p>PlatformIO uses <code>-flto -Os</code> as the default optimization level, but changing those settings didn’t influence the result significantly. <a href=#user-content-fnref-arduino-platformio-optimization class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id=user-content-fn-mbed-pwmout-constructor><p>The <a href=https://os.mbed.com/docs/mbed-os/v6.9/mbed-os-api-doxy/classmbed_1_1_pwm_out.html#ae90809b159b1af641a257b3505c56c41>official documentation for <code>mbed::PwmOut</code></a> does not mention it, but looking through the <a href=https://github.com/ARMmbed/mbed-os/blob/c73413893fb98aaaeda74513c981ac68adc8645d/drivers/source/PwmOut.cpp#L162>source code</a> you can find that <code>PwmOut::init</code> invokes <code>pwmout_init</code> from the hardware abstraction layer, which does indeed initialize the PWM hardware. <a href=#user-content-fnref-mbed-pwmout-constructor class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id=user-content-fn-change-pwm-frequency><p>If you pick the right PWM pins on an AVR board, you can access the registers directly and set the PWM frequency, as described on the <a href="https://www.arduino.cc/en/pmwiki.php?n=Tutorial/SecretsOfArduinoPWM">Arduino Wiki</a>. On an Mbed board, you can just use the <code>mbed::PwmOut</code> class directly. <a href=#user-content-fnref-change-pwm-frequency class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id=user-content-fn-google-sos-blink><p>Google’s indexing of pages changes all the time, and today you might find out <a href=https://forum.arduino.cc/t/arduino-nano-33-ble-damaged/639669/2>this forum post</a>, where the first answer mentions that’s what Mbed does when it crashes, which could be for various reasons. This answer also includes a vague reference to the issue we’re encountering here. <a href=#user-content-fnref-google-sos-blink class=data-footnote-backref aria-label="Back to content" data-footnote-backref="">↩</a></p></li></ol></section></div><div class="mx-auto sm:px-6 max-w-3xl px-6 mt-8 flex flex-col justify-between sm:flex-row"><ul class=mr-5><li class="inline-block bg-gray-100 dark:bg-zinc-700 font-medium lowercase mb-2 mr-2 px-2 py-0.5"><a href=/pr-preview/pr-7/tags/arduino/ class="text-muted dark:hover:text-gray-200 dark:text-zinc-300 hover:text-primary">arduino</a></li><li class="inline-block bg-gray-100 dark:bg-zinc-700 font-medium lowercase mb-2 mr-2 px-2 py-0.5"><a href=/pr-preview/pr-7/tags/software/ class="text-muted dark:hover:text-gray-200 dark:text-zinc-300 hover:text-primary">software</a></li><li class="inline-block bg-gray-100 dark:bg-zinc-700 font-medium lowercase mb-2 mr-2 px-2 py-0.5"><a href=/pr-preview/pr-7/tags/electronics/ class="text-muted dark:hover:text-gray-200 dark:text-zinc-300 hover:text-primary">electronics</a></li></ul><div class="text-gray-500 align-middle dark:text-zinc-600 mt-5 sm:mt-1"><span class="text-gray-400 align-super dark:text-zinc-400 font-bold">Share:</span> <button class=ml-2 data-aw-social-share=twitter data-aw-url=https://vtavernier.github.io/pr-preview/pr-7/posts/arduino-internals-whats-behind-the-magic/ title="Twitter Share" data-aw-text="Arduino Internals — What's behind the magic?"><svg viewBox="0 0 24 24" class="h-6 w-6 dark:hover:text-zinc-300 dark:text-zinc-500 hover:text-black text-gray-400" astro-icon=ri:twitter-fill><path d="M22.162 5.656a8.384 8.384 0 0 1-2.402.658A4.196 4.196 0 0 0 21.6 4c-.82.488-1.719.83-2.656 1.015a4.182 4.182 0 0 0-7.126 3.814 11.874 11.874 0 0 1-8.62-4.37 4.168 4.168 0 0 0-.566 2.103c0 1.45.738 2.731 1.86 3.481a4.168 4.168 0 0 1-1.894-.523v.052a4.185 4.185 0 0 0 3.355 4.101 4.21 4.21 0 0 1-1.89.072A4.185 4.185 0 0 0 7.97 16.65a8.394 8.394 0 0 1-6.191 1.732 11.83 11.83 0 0 0 6.41 1.88c7.693 0 11.9-6.373 11.9-11.9 0-.18-.005-.362-.013-.54a8.496 8.496 0 0 0 2.087-2.165z" fill=currentColor /></svg></button> <button class=ml-2 data-aw-social-share=facebook data-aw-url=https://vtavernier.github.io/pr-preview/pr-7/posts/arduino-internals-whats-behind-the-magic/ title="Facebook Share"><svg viewBox="0 0 24 24" class="h-6 w-6 dark:hover:text-zinc-300 dark:text-zinc-500 hover:text-black text-gray-400" astro-icon=ri:facebook-box-fill><path d="M15.402 21v-6.966h2.333l.349-2.708h-2.682V9.598c0-.784.218-1.319 1.342-1.319h1.434V5.857a19.19 19.19 0 0 0-2.09-.107c-2.067 0-3.482 1.262-3.482 3.58v1.996h-2.338v2.708h2.338V21H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1h-4.598z" fill=currentColor /></svg></button> <button class=ml-2 data-aw-social-share=linkedin data-aw-url=https://vtavernier.github.io/pr-preview/pr-7/posts/arduino-internals-whats-behind-the-magic/ title="Linkedin Share" data-aw-text="Arduino Internals — What's behind the magic?"><svg viewBox="0 0 24 24" class="h-6 w-6 dark:hover:text-zinc-300 dark:text-zinc-500 hover:text-black text-gray-400" astro-icon=ri:linkedin-box-fill><path d="M18.335 18.339H15.67v-4.177c0-.996-.02-2.278-1.39-2.278-1.389 0-1.601 1.084-1.601 2.205v4.25h-2.666V9.75h2.56v1.17h.035c.358-.674 1.228-1.387 2.528-1.387 2.7 0 3.2 1.778 3.2 4.091v4.715zM7.003 8.575a1.546 1.546 0 0 1-1.548-1.549 1.548 1.548 0 1 1 1.547 1.549zm1.336 9.764H5.666V9.75H8.34v8.589zM19.67 3H4.329C3.593 3 3 3.58 3 4.297v15.406C3 20.42 3.594 21 4.328 21h15.338C20.4 21 21 20.42 21 19.703V4.297C21 3.58 20.4 3 19.666 3h.003z" fill=currentColor /></svg></button> <button class=ml-2 data-aw-social-share=mail data-aw-url=https://vtavernier.github.io/pr-preview/pr-7/posts/arduino-internals-whats-behind-the-magic/ title="Email Share" data-aw-text="Arduino Internals — What's behind the magic?"><svg viewBox="0 0 24 24" class="h-6 w-6 dark:hover:text-zinc-300 dark:text-zinc-500 hover:text-black text-gray-400" astro-icon=ri:mail-fill><path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm9.06 8.683L5.648 6.238 4.353 7.762l7.72 6.555 7.581-6.56-1.308-1.513-6.285 5.439z" fill=currentColor /></svg></button></div></div></article></section><div data-issue-term=pathname data-label=comments data-repo=vtavernier/vtavernier.github.io data-theme=github-dark id=utterances-container></div><div class="mx-auto sm:px-6 max-w-3xl px-6 md:pb-20 md:pt-4 pb-12 pt-8"><a href=/pr-preview/pr-7/posts/ class="btn btn-ghost md:px-3 px-3"><svg viewBox="0 0 24 24" class="h-5 w-5 -ml-1.5 mr-1" astro-icon=tabler:chevron-left><path d="m15 6-6 6 6 6" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></svg> Back to Blog</a></div></main><footer class="border-gray-200 border-t dark:border-zinc-800 relative"><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden=true></div><div class="mx-auto sm:px-6 px-4 dark:text-zinc-300 max-w-7xl relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="flex md:mb-0 -ml-2 mb-4 md:ml-4 md:order-1"><li><a href=mailto:v.tavernier@pm.me class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label=E-mail><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon=tabler:mail><g fill=none class=icon-tabler stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><rect height=14 rx=2 width=18 x=3 y=5 /><path d="m3 7 9 6 9-6"/></g></svg></a></li><li><a href=https://github.com/vtavernier class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label=Github><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon=tabler:brand-github><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6 0 0 0-1.3-3.2 4.2 4.2 0 0 0-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3 0 0 0-6.2 0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2 0 0 0-.1 3.2A4.6 4.6 0 0 0 4 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></svg></a></li><li><a href=https://www.linkedin.com/in/vincent-tavernier-707b5012a/ class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label=LinkedIn><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon=tabler:brand-linkedin><g fill=none class=icon-tabler stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><rect height=16 rx=2 width=16 x=4 y=4 /><path d="M8 11v5M8 8v.01M12 16v-5M16 16v-3a2 2 0 0 0-4 0"/></g></svg></a></li><li><a href=https://crates.io/users/vtavernier class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label=crates.io><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon=tabler:package><g fill=none class=icon-tabler stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="m12 3 8 4.5v9L12 21l-8-4.5v-9L12 3M12 12l8-4.5M12 12v9M12 12 4 7.5M16 5.25l-8 4.5"/></g></svg></a></li><li><a href=/pr-preview/pr-7/rss.xml class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label=RSS><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon=tabler:rss><g fill=none class=icon-tabler stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><circle cx=5 cy=19 r=1 /><path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"/></g></svg></a></li></ul><div class="mr-4 dark:text-zinc-400 text-sm">© 2019 ‒ 2023 Vincent Tavernier · All written content licensed under <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ rel=license><abbr title="Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)">CC BY-NC-SA 4.0</abbr></a> unless otherwise specified · Blog theme based on <a href=https://github.com/onwidget/astrowind class="items-center inline-flex" rel=external target=_blank>AstroWind <svg viewBox="0 0 24 24" class="inline-block h-4 w-4 mx-1" astro-icon=tabler:external-link><g fill=none class=icon-tabler stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M11 7H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-5M10 14 20 4M15 4h5v5"/></g></svg></a></div></div></div></footer><script type=module>import mermaid from"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";mermaid.initialize({startOnLoad:!0,theme:"dark"})</script><script>!function(){const e="dark:only";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function a(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light")})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),a=encodeURIComponent(t.getAttribute("data-aw-text"));let c;switch(o){case"facebook":c=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":c=`https://twitter.com/intent/tweet?url=${n}&text=${a}`;break;case"linkedin":c=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${a}`;break;case"whatsapp":c=`https://wa.me/?text=${a}%20${n}`;break;case"mail":c=`mailto:?subject=%22${a}%22&body=${a}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=c,s.click()})),a(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{a()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>