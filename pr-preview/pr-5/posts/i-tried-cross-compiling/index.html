<!DOCTYPE html><html class="2xl:text-[20px]" dir="ltr" lang="en"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>I tried cross-compiling for the Raspberry Pi — The Tavern</title><meta content="index,follow" name="robots"/><meta content="I tried cross-compiling for the Raspberry Pi. And it went horribly wrong." name="description"/><meta content="summary_large_image" name="twitter:card"/><meta content="I tried cross-compiling for the Raspberry Pi" property="og:title"/><meta content="I tried cross-compiling for the Raspberry Pi. And it went horribly wrong." property="og:description"/><meta content="https://vtavernier.github.io/pr-preview/pr-5/posts/i-tried-cross-compiling/" property="og:url"/><meta content="article" property="og:type"/><meta content="https://vtavernier.github.io/pr-preview/pr-5/_astro/raspberry-pi-01.4ca63bde.jpg" property="og:image"/><meta content="I tried cross-compiling for the Raspberry Pi" property="og:image:alt"/><link href="https://vtavernier.github.io/pr-preview/pr-5/posts/i-tried-cross-compiling/" rel="canonical"/><style is:global>:root{--aw-font-sans:'InterVariable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:rgb(89 30 100);--aw-color-secondary:rgb(94 30 100);--aw-color-accent:rgb(100 59 40);--aw-color-text-page:rgb(39 17 39);--aw-color-text-muted:rgb(97 75 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content="9T4KIucFxDdjqi0gdKxvMbVSluLphiFhgBc3iCSAKqk" name="google-site-verification"><link href="/pr-preview/pr-5/favicon.ico" rel="shortcut icon"><link href="/pr-preview/pr-5/favicon.svg" rel="icon" type="image/svg+xml"><link href="/pr-preview/pr-5/favicon.svg" rel="mask-icon" color="#8D46E7"><link href="/pr-preview/pr-5/_astro/index.89fc2001.css" rel="stylesheet"/><link href="/pr-preview/pr-5/_astro/index.5103e8c1.css" rel="stylesheet"/><script type="module">const t=document.createElement("script"),a=document.querySelector("#utterances-container"),e=a.attributes;Object.entries({src:"https://utteranc.es/client.js",repo:e["data-repo"].value,"issue-term":e["data-issue-term"].value,label:e["data-label"].value,theme:e["data-theme"].value,crossorigin:"anonymous"}).forEach((([e,a])=>{t.setAttribute(e,a)})),a?.appendChild(t)</script></head><body class="dark:text-zinc-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="mx-auto w-full duration-100 ease-in flex-none sticky top-0 transition-all z-40" id="header"><div class="mx-auto max-w-7xl md:flex md:justify-between md:px-4 md:py-3.5 px-3 py-3 w-full"><div class="flex justify-between"><a href="/pr-preview/pr-5/" class="items-center flex"><span class="ml-2 dark:text-white font-bold md:text-xl self-center text-2xl text-gray-900 whitespace-nowrap"><svg viewBox="0 0 68.792 68.792" class="inline" height="32" width="32"><g style="fill:#2f3136;stroke:#8aa2d3;stroke-width:1.98438"><path d="M30.088 56.162V24.233h13.89v31.93ZM6.068 20.085V6.195h63.183l-13.89 13.89Z" transform="translate(-3.264 3.218)"></path></g></svg> The Tavern</span></a><div class="items-center flex md:hidden"><button class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm hover:bg-gray-100 dark:hover:bg-gray-800 ml-1.5 text-gray-500 transition" aria-label="Toggle Menu" data-aw-toggle-menu type="button"><svg viewBox="0 0 24 24" class="h-6 w-6" astro-icon="tabler:menu" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g fill="none" class="icon-tabler" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4 8h16"/><path d="M4 16h16"/></g></svg></button></div></div><nav aria-label="Main navigation" class="items-center hidden md:flex dark:text-zinc-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 text-xl w-full"><li class=""><a href="/pr-preview/pr-5/posts/" class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-gray-900 px-4 py-3 transition">Blog</a></li><li class=""><a href="https://github.com/vtavernier?tab=repositories&#38;q=&#38;type=source&#38;language=&#38;sort=" class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-gray-900 px-4 py-3 transition">Projects</a></li><li class=""><a href="/pr-preview/pr-5/research/" class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-gray-900 px-4 py-3 transition">Research</a></li><li class=""><a href="/pr-preview/pr-5/about/" class="items-center flex dark:hover:text-white duration-150 ease-in-out font-medium hover:text-gray-900 px-4 py-3 transition">About me</a></li></ul></nav><div class="items-center flex md:mb-0 md:self-center"><div class="items-center hidden md:flex"><a href="/pr-preview/pr-5/rss.xml" class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-gray-700 hover:bg-gray-100" aria-label="RSS Feed"><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon="tabler:rss"><g fill="none" class="icon-tabler" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"/></g></svg></a></div></div></div></header><main><section class="mx-auto lg:py-20 py-8 sm:py-16"><article><header class=""><div class="flex px-4 flex-col justify-between max-w-3xl mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p><svg viewBox="0 0 24 24" class="inline-block h-4 w-4 -mt-0.5 dark:text-gray-400" astro-icon="tabler:clock"><g fill="none" class="icon-tabler" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></g></svg> <time datetime="Mon Nov 15 2021 00:00:00 GMT+0000 (Coordinated Universal Time)">Nov 15, 2021</time> · <a href="/pr-preview/pr-5/category/embedded-programming/" class="capitalize hover:underline">embedded programming</a></p></div><h1 class="mx-auto sm:px-6 max-w-3xl px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">I tried cross-compiling for the Raspberry Pi</h1><p class="mx-auto sm:px-6 max-w-3xl px-4 dark:text-zinc-400 mb-8 md:text-2xl mt-4 text-muted text-xl">A story of cross-compilers and obscure platform details.</p><picture><source sizes="(max-width: 900px) 400px, 900px" srcset="/pr-preview/pr-5/_astro/raspberry-pi-01.4ca63bde_Z2rRKYT.avif 400w,/pr-preview/pr-5/_astro/raspberry-pi-01.4ca63bde_KXVEk.avif 900w" type="image/avif"><source sizes="(max-width: 900px) 400px, 900px" srcset="/pr-preview/pr-5/_astro/raspberry-pi-01.4ca63bde_Z1IwW28.webp 400w,/pr-preview/pr-5/_astro/raspberry-pi-01.4ca63bde_1ujKC6.webp 900w" type="image/webp"><source sizes="(max-width: 900px) 400px, 900px" srcset="/pr-preview/pr-5/_astro/raspberry-pi-01.4ca63bde_Z22jNJX.jpg 400w,/pr-preview/pr-5/_astro/raspberry-pi-01.4ca63bde_m72QE.jpg 900w" type="image/jpeg"><img alt="I tried cross-compiling for the Raspberry Pi. And it went horribly wrong." class="mx-auto bg-gray-400 dark:bg-zinc-700 lg:max-w-6xl max-w-full mb-6 sm:rounded-md" decoding="async" height="506" loading="eager" src="/pr-preview/pr-5/_astro/raspberry-pi-01.4ca63bde_m72QE.jpg" width="900"></picture></header><div class="mx-auto sm:px-6 max-w-3xl px-6 mt-8 dark:prose-a:text-purple-400 dark:prose-headings:text-zinc-300 dark:prose-invert prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow-lg prose-md"><blockquote><p>And it went horribly wrong.</p></blockquote><p>In software development there are tasks which are easy and others which are… <em>less easy</em>™. This post tells the story of how I managed to cross-compile a Rust project with native dependencies for the Raspberry Pi Zero regardless of the many, <strong>many</strong> pitfalls of cross-compiling. If you — like me — enjoy spending your spare time battling with toolchains and obscure compilation flags, you will probably enjoy this tale.</p><h1 id="context">Context</h1><p>I went down this rabbit hole while working on <a href="https://github.com/vtavernier/hyperion.rs">hyperion.rs</a>, my Rust reimplementation of the <a href="https://hyperion-project.org/">Hyperion</a> ambient lighting daemon. More specifically in this project, settings are persisted in a SQLite database, and lighting effects can be programmed using Python. Those constitute our two native dependencies we will focus on here.</p><p>Instead of compiling the entire project, we will focus on the PoC available <a href="https://github.com/vtavernier/blog-cross-rpi">here</a>. This is a simple Rust program which uses the <a href="https://crates.io/crates/sqlite">sqlite</a> and <a href="https://crates.io/crates/pyo3">pyo3</a> crates to display some strings and floating-point values. In order to test various compiling scenarios, both crates are gated by the <code>sql</code> and <code>python</code> features respectively. With both features enabled, this is the entire program:</p><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#ff79c6">use</span><span style="color:#f8f8f2"> color_eyre</span><span style="color:#ff79c6">::</span><span style="color:#f8f8f2">eyre</span><span style="color:#ff79c6">::</span><span style="color:#8be9fd">Result</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#ff79c6">use</span><span style="color:#f8f8f2"> pyo3</span><span style="color:#ff79c6">::</span><span style="color:#f8f8f2">prelude</span><span style="color:#ff79c6">::*</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">#[pyclass]</span></span>
<span class="line"><span style="color:#f8f8f2">#[derive(</span><span style="color:#8be9fd">Default</span><span style="color:#f8f8f2">, </span><span style="color:#8be9fd">Debug</span><span style="color:#f8f8f2">, </span><span style="color:#8be9fd">Clone</span><span style="color:#f8f8f2">)]</span></span>
<span class="line"><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">User</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">    name</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">String</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">    age</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">f64</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">/// Get users from the SQLite database</span></span>
<span class="line"><span style="color:#ff79c6">fn</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">get_users</span><span style="color:#f8f8f2">() </span><span style="color:#ff79c6">-&gt;</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">Result</span><span style="color:#f8f8f2">&lt;</span><span style="color:#8be9fd">Vec</span><span style="color:#f8f8f2">&lt;</span><span style="color:#8be9fd">User</span><span style="color:#f8f8f2">&gt;&gt; {</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">use</span><span style="color:#f8f8f2"> sqlite</span><span style="color:#ff79c6">::</span><span style="color:#8be9fd">State</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">    // From the sqlite crate example</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">let</span><span style="color:#f8f8f2"> connection </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> sqlite</span><span style="color:#ff79c6">::</span><span style="color:#50fa7b">open</span><span style="color:#f8f8f2">(</span><span style="color:#f1fa8c">&quot;:memory:&quot;</span><span style="color:#f8f8f2">)</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    connection</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#f8f8f2">(</span></span>
<span class="line"><span style="color:#f8f8f2">        </span><span style="color:#f1fa8c">&quot;</span></span>
<span class="line"><span style="color:#f1fa8c">        CREATE TABLE users (name TEXT, age INTEGER);</span></span>
<span class="line"><span style="color:#f1fa8c">        INSERT INTO users VALUES (&#39;Alice&#39;, 42.5);</span></span>
<span class="line"><span style="color:#f1fa8c">        INSERT INTO users VALUES (&#39;Bob&#39;, 69.69);</span></span>
<span class="line"><span style="color:#f1fa8c">        &quot;</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">    )</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">let</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">mut</span><span style="color:#f8f8f2"> statement </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> connection</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">prepare</span><span style="color:#f8f8f2">(</span><span style="color:#f1fa8c">&quot;SELECT * FROM users&quot;</span><span style="color:#f8f8f2">)</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">let</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">mut</span><span style="color:#f8f8f2"> result </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">Vec</span><span style="color:#ff79c6">::</span><span style="color:#50fa7b">with_capacity</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">2</span><span style="color:#f8f8f2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">while</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">let</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">State</span><span style="color:#ff79c6">::</span><span style="color:#8be9fd">Row</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> statement</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#f8f8f2">()</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">        result</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">push</span><span style="color:#f8f8f2">(</span><span style="color:#8be9fd">User</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">            name</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> statement</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">read</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">)</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">            age</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> statement</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">read</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">)</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">        });</span></span>
<span class="line"><span style="color:#f8f8f2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#8be9fd">Ok</span><span style="color:#f8f8f2">(result)</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">/// Print user names using Python</span></span>
<span class="line"><span style="color:#ff79c6">fn</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">python_print</span><span style="color:#f8f8f2">(users</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">Vec</span><span style="color:#f8f8f2">&lt;</span><span style="color:#8be9fd">User</span><span style="color:#f8f8f2">&gt;) </span><span style="color:#ff79c6">-&gt;</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">Result</span><span style="color:#f8f8f2">&lt;()&gt; {</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">use</span><span style="color:#f8f8f2"> pyo3</span><span style="color:#ff79c6">::</span><span style="color:#f8f8f2">types</span><span style="color:#ff79c6">::*</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    #[pymethods]</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">impl</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">User</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">        #[getter]</span></span>
<span class="line"><span style="color:#f8f8f2">        </span><span style="color:#ff79c6">fn</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">name</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&amp;</span><span style="color:#bd93f9">self</span><span style="color:#f8f8f2">) </span><span style="color:#ff79c6">-&gt;</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&amp;</span><span style="color:#8be9fd">str</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">            </span><span style="color:#bd93f9">self</span><span style="color:#ff79c6">.</span><span style="color:#f8f8f2">name</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">as_str</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">        }</span></span>
<span class="line"><span style="color:#f8f8f2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#8be9fd">Python</span><span style="color:#ff79c6">::</span><span style="color:#50fa7b">with_gil</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">|</span><span style="color:#f8f8f2">py</span><span style="color:#ff79c6">|</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">        </span><span style="color:#ff79c6">let</span><span style="color:#f8f8f2"> locals </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">PyDict</span><span style="color:#ff79c6">::</span><span style="color:#50fa7b">new</span><span style="color:#f8f8f2">(py);</span></span>
<span class="line"><span style="color:#f8f8f2">        locals</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">set_item</span><span style="color:#f8f8f2">(</span></span>
<span class="line"><span style="color:#f8f8f2">            </span><span style="color:#f1fa8c">&quot;users&quot;</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">            </span><span style="color:#8be9fd">PyList</span><span style="color:#ff79c6">::</span><span style="color:#50fa7b">new</span><span style="color:#f8f8f2">(</span></span>
<span class="line"><span style="color:#f8f8f2">                py,</span></span>
<span class="line"><span style="color:#f8f8f2">                users</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">into_iter</span><span style="color:#f8f8f2">()</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">map</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">|</span><span style="color:#f8f8f2">user</span><span style="color:#ff79c6">|</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">PyCell</span><span style="color:#ff79c6">::</span><span style="color:#50fa7b">new</span><span style="color:#f8f8f2">(py, user)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">unwrap</span><span style="color:#f8f8f2">()),</span></span>
<span class="line"><span style="color:#f8f8f2">            ),</span></span>
<span class="line"><span style="color:#f8f8f2">        )</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">        py</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">run</span><span style="color:#f8f8f2">(</span><span style="color:#f1fa8c">&quot;print([user.name for user in users])&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#8be9fd">None</span><span style="color:#f8f8f2">, </span><span style="color:#8be9fd">Some</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&amp;</span><span style="color:#f8f8f2">locals))</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">        </span><span style="color:#8be9fd">Ok</span><span style="color:#f8f8f2">(())</span></span>
<span class="line"><span style="color:#f8f8f2">    })</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">fn</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">main</span><span style="color:#f8f8f2">() </span><span style="color:#ff79c6">-&gt;</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">Result</span><span style="color:#f8f8f2">&lt;()&gt; {</span></span>
<span class="line"><span style="color:#f8f8f2">    color_eyre</span><span style="color:#ff79c6">::</span><span style="color:#50fa7b">install</span><span style="color:#f8f8f2">()</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">    // Get users</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">let</span><span style="color:#f8f8f2"> users </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">get_users</span><span style="color:#f8f8f2">()</span><span style="color:#ff79c6">?</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">    // Print users for debugging</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#50fa7b">println!</span><span style="color:#f8f8f2">(</span><span style="color:#f1fa8c">&quot;Read users from sqlite: {:#?}&quot;</span><span style="color:#f8f8f2">, users);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#50fa7b">python_print</span><span style="color:#f8f8f2">(users)</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>Which is nothing too fancy. If this program compiles and runs on the target, it means we obtained a working binary which properly linked to the native dependencies we mentioned, and uses the proper ABI (this is especially important for ARM targets which have many different floating point ABIs). My goal here was to:</p><ul><li>Compile a binary for the Raspberry Pi Zero with reasonable speed</li><li>Automate this process so it can run in continuous integration</li><li>Limit as much as possible the required per-project setup</li></ul><p>So let’s get started!</p><h1 id="cross-compiling-101">Cross-compiling 101</h1><p>The problem we will be tackling here uses the following concepts:</p><ul><li><strong>Compiling</strong>: the process of turning source code into machine code using a <em>compiler</em>. Or multiple if you have multiple source languages to compile.</li><li><strong>Linking</strong>: the process of assembling machine objects into the final binary. Inputs to the linking stage are parts of the project you are compiling, as well as third party dependencies like <em>libc</em> — and in our case <em>libsqlite3</em> and <em>libpython3</em>.</li><li><strong>Host</strong>: the system you are compiling on. This one runs the <em>compiler</em>.</li><li><strong>Target</strong>: the system you run the compiled program on.</li><li><strong>Cross-compiling</strong>: compiling a program when the <em>host</em> is different from the <em>target</em>. This is done using a <em>cross-compiler</em> which runs on the <em>host</em> and creates programs to run on the <em>target</em>.</li></ul><p>When you got started with programming using compiled languages, you were likely compiling natively: the target architecture for which you are compiling your programs is the same that runs your compiler. This is the simplest situation, represented below. In a nutshell:</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#6272a4"># The gcc command whithout -c invokes the compiler and the linker in sequence</span></span>
<span class="line"><span style="color:#6272a4"># This one compiles main.c and links with either libsomething.a or libsomething.so</span></span>
<span class="line"><span style="color:#f8f8f2">$ gcc -lsomething main.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">$ ./a.out</span></span>
<span class="line"><span style="color:#6272a4"># Your program runs, congratulations!</span></span></code></pre></div><figure><div class="mermaid">graph LR subgraph Host[&quot;Host (and target)&quot;] Compiler[/&quot;Compiler (gcc, clang)&quot;/] int_files Linker[/&quot;Linker (ld, lld)&quot;/] so_files[&quot;Libraries (.a, .so)&quot;] binary[&quot;Binary&quot;] end src_files[&quot;Source files (.c, .cpp)&quot;] --&gt; Compiler --&gt; int_files[&quot;Object files (.o)&quot;] --&gt; Linker so_files --&gt; Linker --&gt; binary</div><figcaption>Native compiling: compiling and running the program happens on the host</figcaption></figure><p>If you kept going and developed for a microcontroller-based platform such as Arduino, Espressif devices and countless others, you <strong>have</strong> used a cross-compiler. Indeed, these platforms can neither host a full operating system needed by the compiler nor provide the required computational power to compile modern languages.</p><p>However, some more powerful embedded platforms do provide operating systems and compilers: today’s subject, the Raspberry Pi, runs a full Debian distribution and contains all the required tools for developing compiled software — albeit requiring some patience while the low-power ARM cores churn away to produce the binaries for your project.</p><p>Both those cases are represented below. Dynamic libraries are only present if the target platform has a dynamic linker, such as Linux embedded targets. The previous compilation process gets slightly more complex:</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#6272a4"># All the gcc and binutils (cross-)tools are prefixed with the target triplet,</span></span>
<span class="line"><span style="color:#6272a4"># here &quot;arm-linux-gnueabihf&quot;. This one compiles main.c and links with</span></span>
<span class="line"><span style="color:#6272a4"># libsomething.a/.so, but for &quot;arm-linux-gnueabihf&quot;.</span></span>
<span class="line"><span style="color:#f8f8f2">$ arm-linux-gnueabihf-gcc -lsomething main.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">$ ./a.out</span></span>
<span class="line"><span style="color:#f8f8f2">Exec format error.</span></span>
<span class="line"><span style="color:#6272a4"># This message indicates you are trying to run a binary for the wrong architecture.</span></span>
<span class="line"><span style="color:#6272a4"># You will get used to it as you try cross-compiling things.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># Deploy the binary to the target hardware (or upload using DFU for microcontrollers)</span></span>
<span class="line"><span style="color:#f8f8f2">$ scp a.out pi@raspberry:</span><span style="color:#ff79c6">~</span><span style="color:#f8f8f2">∕</span></span>
<span class="line"><span style="color:#6272a4"># Run it</span></span>
<span class="line"><span style="color:#f8f8f2">$ ssh pi@raspberry ./a.out</span></span></code></pre></div><figure><div class="mermaid">graph LR subgraph Host Compiler[/&quot;Compiler (gcc, clang)&quot;/] Linker[/&quot;Linker (ld, lld)&quot;/] subgraph target_only[&quot;Target architecture objects&quot;] int_files[&quot;Object files (.o)&quot;] end end subgraph Target so_files[&quot;Libraries (.a, .so)&quot;] binary[&quot;Binary&quot;] end src_files[&quot;Source files (.c, .cpp)&quot;] --&gt; Compiler --&gt; int_files --&gt; Linker so_files --&gt; Linker --&gt; binary linkStyle 3 stroke-dasharray: 5 5 style so_files stroke-dasharray: 5 5</div><figcaption>Cross-compiling: compiling happens on the host, and running on the target</figcaption></figure><h2 id="rust-and-the-case-of-rustc">Rust, and the case of <code>rustc</code></h2><p>You have probably noticed the two previous charts only mentioned <code>gcc</code> and <code>clang</code>, i.e. C compilers. And this article started with a Rust example, so what gives?</p><p>What actually happens when you compile a Rust project is the following:</p><ul><li><code>cargo</code> fetches dependencies and invokes <code>rustc</code> to compile all the libraries, proc-macros and build scripts<ul><li>Build scripts may build native dependencies written in C/C++ during this process</li></ul></li><li><code>cargo</code> then invokes <code>rustc</code> to produce the final binary</li><li><code>rustc</code> invokes the system’s linker for the target</li></ul><p>On Linux systems, the (native) system linker used is <code>cc</code>, which usually is a symlink to the system’s version of <code>gcc</code>. On Windows, <code>CL.exe</code> will be invoked when using the <code>x86_64-pc-windows-msvc</code> target. You were probably prompted by <code>rustup</code> when installing Rust that you need to have a C compiler available (Linux), or to install the Visual C++ Build Tools (Windows) so <code>cargo build</code> works out-of-box once you have installed Rust.</p><p>This means that native compiling Rust is as follows:</p><figure><div class="mermaid">graph LR subgraph Sources rs_files c_sources end subgraph Host[&quot;Host (and target)&quot;] native_linker[/&quot;Linker (cc)&quot;/] target_linker[/&quot;Linker (cc)&quot;/] so_files[&quot;Libraries (.a, .so)&quot;] binary[&quot;Binary&quot;] subgraph cargo rustc native_linker build_scripts proc_macros end cc a rlib build_scripts-. invokes .-&gt;cc proc_macros-. used by .-&gt;rustc end rs_files[&quot;Sources (.rs)&quot;] --&gt; rustc[/rustc/] --&gt; rlib[&quot;Rust libraries (.rlib)&quot;] native_linker --&gt; build_scripts[&quot;Build scripts&quot;] native_linker --&gt; proc_macros[&quot;Proc macros (.so)&quot;] rustc --&gt; native_linker c_sources[&quot;Sources (.c)&quot;] --&gt; cc[/cc/] --&gt; a[&quot;Static libraries (.a)&quot;] rlib --&gt; target_linker a --&gt; target_linker so_files --&gt; target_linker target_linker --&gt; binary</div><figcaption>Native compiling Rust with non-Rust dependencies</figcaption></figure><p>… and remember how cross-compiling makes everything more complicated? Here, we need to generate code:</p><ul><li>For the target: the actual program that will run on the target architecture</li><li>For the host: build scripts and proc-macros are Rust code that runs on the host</li></ul><p>So, when we are cross-compiling Rust, we need <strong>both</strong> a native linker and a cross linker for the target. As well as a native C compiler, if we have non-Rust build dependencies, and a C cross-compiler if we have non-Rust dependencies. I promise this is the last overly wide graph of this introduction before we get to the point.</p><figure><div class="mermaid">graph LR subgraph Sources rs_files c_sources end subgraph Host native_linker[/&quot;Linker (cc)&quot;/] target_linker[/&quot;Target linker (ARCH-cc)&quot;/] subgraph cargo rustc native_linker build_scripts proc_macros end cc[/&quot;ARCH-cc&quot;/] subgraph target_only[&quot;Target architecture objects&quot;] rlib a end build_scripts-. invokes .-&gt;cc proc_macros-. used by .-&gt;rustc end subgraph Target target_so_files[&quot;Libraries (.a, .so)&quot;] binary[&quot;Binary&quot;] end rs_files[&quot;Sources (.rs)&quot;] --&gt; rustc[/rustc/] --&gt; rlib[&quot;Rust libraries (.rlib)&quot;] native_linker --&gt; build_scripts[&quot;Build scripts&quot;] native_linker --&gt; proc_macros[&quot;Proc macros (.so)&quot;] rustc --&gt; native_linker c_sources[&quot;Sources (.c)&quot;] --&gt; cc --&gt; a[&quot;Static libraries (.a)&quot;] rlib --&gt; target_linker a --&gt; target_linker target_so_files --&gt; target_linker target_linker --&gt; binary</div><figcaption>Cross-compiling Rust with non-Rust dependencies. <em>ARCH</em> is the target architecture prefix.<br/>Note: the case where proc macros or build scripts have C dependencies or link to system libraries is not represented here and is left as an exercise to readers who need more spaghetti in their lives. 🍝</figcaption></figure><p>So, why do we need that extra complexity, especially if the target <em>has</em> native compilers which we could invoke the same way we do native development on desktop?</p><h1 id="why-cross-compile">Why cross-compile?</h1><p>Ranking the reasons for cross-compiling from “required” to “convenient”, these are the main reasons:</p><ul><li>No target-hosted compiler is available (microcontrollers)</li><li>A compiler is available, but you do not have access to the target (either because you don’t own the hardware, or the build process is running on continuous integration servers).</li><li>Limited target hardware performance. Compiling the PoC for this article results in the following:</li></ul><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#6272a4"># Preparation: fetch all dependencies</span></span>
<span class="line"><span style="color:#f8f8f2">$ cargo clean </span><span style="color:#ff79c6">&amp;&amp;</span><span style="color:#f8f8f2"> cargo fetch</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># Compile the project in release mode</span></span>
<span class="line"><span style="color:#f8f8f2">$ cargo build --offline --release --all-features</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># x86_64 Ryzen 7 5800X (Desktop PC)</span></span>
<span class="line"><span style="color:#f8f8f2">Finished release [optimized] target(s) </span><span style="color:#ff79c6">in</span><span style="color:#f8f8f2"> 9.07s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># ARMv6l BCM2835 (Raspberry Pi Zero)</span></span>
<span class="line"><span style="color:#f8f8f2">Finished release [optimized] target(s) </span><span style="color:#ff79c6">in</span><span style="color:#f8f8f2"> 55m 21s</span></span></code></pre></div><p>The Raspberry Pi Zero is thus <em><strong>366 times</strong></em> slower than my desktop PC at compiling the example code. Granted, it won’t heat up my office as much as a CPU with a 105W TDP. Note that network and I/O performance is also much worse on embedded targets, but we have waited long enough!</p><h1 id="acquiring-a-cross-compiler">Acquiring a cross-compiler</h1><p>As I have mentioned previously, to cross-compile you need a cross-compiler for your target architecture. Architectures are usually identified using <em>triplets</em> which are strings of the form <code>machine-vendor-operatingsystem</code><sup><a href="#user-content-fn-osdev-target-triplets" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-osdev-target-triplets">1</a></sup>. Some examples of triplets are:</p><ul><li>x86_64-linux-gnu: Linux running on x86_64 CPUs, using the GNU toolchain</li><li>riscv64-none-elf: Bare-metal ELF, running on RISC-V CPUs</li><li>arm-linux-gnueabihf: Linux running on ARM CPUs, using the GNU toolchain, with hardfp floating point ABI</li></ul><p>With enough luck, the compiler you need for your target will be available in your favorite distribution’s repositories, and it becomes a simple matter of <code>sudo apt install gcc-arm-linux-gnueabihf</code>. Otherwise, you can download cross-compiling toolchains from third parties (for recent ARM targets, check out the <a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-a/downloads">Arm Developer</a> page).</p><p>You can then test the acquired compiler with a simple program:</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">$ cat </span><span style="color:#ff79c6">&lt;&lt;EOT</span><span style="color:#f1fa8c"> &gt;main.c</span></span>
<span class="line"><span style="color:#f1fa8c">#include &lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f1fa8c">int main() {</span></span>
<span class="line"><span style="color:#f1fa8c">  printf(&quot;Hello, world!\n&quot;);</span></span>
<span class="line"><span style="color:#f1fa8c">  return 0;</span></span>
<span class="line"><span style="color:#f1fa8c">}</span></span>
<span class="line"><span style="color:#ff79c6">EOT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">$ arm-linux-gnueabihf-gcc main.c</span></span></code></pre></div><p>Unsurprisingly, it compiles without warnings or errors. And when you transfer it to our target of the day, a Raspberry Pi Zero, and run it:</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">$ ./a.out</span></span>
<span class="line"><span style="color:#f8f8f2">Segmentation fault</span></span></code></pre></div><p>Which is a disappointment, to say the least. We have acquired the right toolchain (i.e. <code>arm-linux-gnueabihf</code>), as <a href="https://hackaday.com/2016/02/03/code-craft-cross-compiling-for-the-raspberry-pi/">tutorials</a> and the <a href="https://github.com/raspberrypi/tools">raspberrypi/tools repository</a> mention… The right toolchain, aside from one minor detail of this repository’s README:</p><blockquote><p>Note: if building for Pi0/1 using <code>--with-arch=armv6 --with-float=hard --with-fpu=vfp</code> is recommended (and matches the default flags of the toolchains included here).</p></blockquote><p>Time for some digging.</p><h1 id="naming-things-is-hard">Naming things is hard</h1><p>Running the following commands on a Raspberry Pi Zero, we obtain this output:</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">$ dpkg --print-architecture</span></span>
<span class="line"><span style="color:#f8f8f2">armhf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">$ </span><span style="color:#8be9fd">echo</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">$MACHTYPE</span></span>
<span class="line"><span style="color:#f8f8f2">arm-unknown-linux-gnueabihf</span></span></code></pre></div><p><code>armhf</code> is the Debian architecture for the distribution’s packages, and <code>arm-unknown-linux-gnueabihf</code> is the GNU triplet<sup><a href="#user-content-fn-triplet-fullform" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-triplet-fullform">2</a></sup> binaries for this system are compiled for. Currently, everything matches, so let’s look a little closer at binaries that run (and those that don’t).</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="mt-0" style="background-color:#282a36;color:var(--tw-prose-pre-code)">
<span style="color:gray"># Read architecture specific information with readelf -A
# Compare the output for /bin/bash (which works) and our a.out (which does not work)</span>
$ <span style="font-weight:700;color:#fff">diff -u --color &lt;(readelf -A /bin/bash) &lt;(readelf -A a.out)</span>
--- /dev/fd/63  2021-10-27 23:24:35.083790612 +0200
+++ /dev/fd/62  2021-10-27 23:24:35.083790612 +0200
@@ -1,10 +1,11 @@
 Attribute Section: aeabi
 File Attributes
<span style="color:red">-  Tag_CPU_name: "6"
-  Tag_CPU_arch: v6</span>
<span class="text-green">+  Tag_CPU_name: "7-A"
+  Tag_CPU_arch: v7
+  Tag_CPU_arch_profile: Application</span>
   Tag_ARM_ISA_use: Yes
<span style="color:red">-  Tag_THUMB_ISA_use: Thumb-1
-  Tag_FP_arch: VFPv2</span>
<span class="text-green">+  Tag_THUMB_ISA_use: Thumb-2
+  Tag_FP_arch: VFPv3-D16</span>
   Tag_ABI_PCS_wchar_t: 4
   Tag_ABI_FP_rounding: Needed
   Tag_ABI_FP_denormal: Needed
</pre></div><p>So our host’s <code>arm-linux-gnueabihf-gcc</code> produces ARMv7-A binaries while the Raspberry Pi Zero expects ARMv6 binaries?</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="mt-0" style="background-color:#282a36;color:var(--tw-prose-pre-code)">
# Host
$ arm-linux-gnueabihf-gcc -v
Using built-in specs.
COLLECT_GCC=arm-linux-gnueabihf-gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc-cross/arm-linux-gnueabihf/10/lto-wrapper
Target: arm-linux-gnueabihf
Configured with: ../src/configure -v --with-pkgversion='Debian 10.2.1-6'
--with-bugurl=file:///usr/share/doc/gcc-10/README.Bugs --enable-languages=c,ada,c++,go,d,fortran,objc,obj-c++,m2
--prefix=/usr --with-gcc-major-version-only --program-suffix=-10 --enable-shared --enable-linker-build-id
--libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls
--with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes
--with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-libitm --disable-libquadmath
--disable-libquadmath-support --enable-plugin --enable-default-pie --with-system-zlib
--enable-libphobos-checking=release --without-target-system-zlib --enable-multiarch --disable-sjlj-exceptions
<span style="font-weight:700;color:#fff">--with-arch=armv7-a --with-fpu=vfpv3-d16 --with-float=hard</span> --with-mode=thumb --disable-werror --enable-checking=release
--build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=arm-linux-gnueabihf --program-prefix=arm-linux-gnueabihf-
--includedir=/usr/arm-linux-gnueabihf/include --with-build-config=bootstrap-lto-lean --enable-link-mutex
Thread model: posix
Supported LTO compression algorithms: zlib
gcc version 10.2.1 20210110 (Debian 10.2.1-6)

# Raspberry Pi
$ gcc -v
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/arm-linux-gnueabihf/10/lto-wrapper
Target: arm-linux-gnueabihf
Configured with: ../src/configure -v --with-pkgversion='Raspbian 10.2.1-6+rpi1'
--with-bugurl=file:///usr/share/doc/gcc-10/README.Bugs --enable-languages=c,ada,c++,go,d,fortran,objc,obj-c++,m2
--prefix=/usr --with-gcc-major-version-only --program-suffix=-10 --program-prefix=arm-linux-gnueabihf-
--enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix
--libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug
--enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-libitm
--disable-libquadmath --disable-libquadmath-support --enable-plugin --with-system-zlib
--enable-libphobos-checking=release --with-target-system-zlib=auto --enable-objc-gc=auto --enable-multiarch
--disable-sjlj-exceptions <span style="font-weight:700;color:#fff">--with-arch=armv6 --with-fpu=vfp --with-float=hard</span> --disable-werror --enable-checking=release --build=arm-linux-gnueabihf
--host=arm-linux-gnueabihf --target=arm-linux-gnueabihf
Thread model: posix
Supported LTO compression algorithms: zlib zstd
gcc version 10.2.1 20210110 (Raspbian 10.2.1-6+rpi1)
</pre></div><p><em><strong>Yes.</strong></em> And if you happen to look at the source for the Raspbian (Raspberry Pi’s version of the Debian distribution) package for GCC 10, you will notice that it was patched to build ARMv6 code:</p><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4"># http://mirrordirector.raspbian.org/raspbian/pool/main/g/gcc-10/gcc-10_10.3.0-8.debian.tar.xz</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4"># debian/rules2</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4"># ...</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#ff79c6">ifneq</span><span style="color:#f8f8f2"> (,</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd">filter</span><span style="color:#f1fa8c"> </span><span style="color:#bd93f9">%</span><span style="color:#f1fa8c">armhf,</span><span style="color:#ff79c6">$(</span><span style="color:#f8f8f2">DEB_TARGET_ARCH</span><span style="color:#ff79c6">))</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">ifeq</span><span style="color:#f8f8f2"> (</span><span style="color:#ff79c6">$(</span><span style="color:#f8f8f2">distribution</span><span style="color:#ff79c6">)</span><span style="color:#f8f8f2">,Raspbian)</span></span>
<span class="line"><span style="color:#f8f8f2">      with_arm_arch </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> armv6</span></span>
<span class="line"><span style="color:#f8f8f2">      with_arm_fpu </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> vfp</span></span>
<span class="line"><span style="color:#ff79c6">    else</span></span>
<span class="line"><span style="color:#f8f8f2">      with_arm_arch </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> armv7-a</span></span>
<span class="line"><span style="color:#f8f8f2">      with_arm_fpu </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> vfpv3-d16</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">endif</span></span>
<span class="line"><span style="color:#ff79c6">  else</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4"># ...</span></span></code></pre><p>On a side note, Rust/LLVM gets this <em>naming different things a different way</em><sup><a href="#user-content-fn-naming-things" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-naming-things">3</a></sup> thing right:</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="mt-0" style="background-color:#282a36;color:var(--tw-prose-pre-code)">$ rustup target list | grep arm
arm-linux-androideabi
arm-unknown-linux-gnueabi
<span style="font-weight:700">arm-unknown-linux-gnueabihf</span> &lt;— ARMv6 target
arm-unknown-linux-musleabi
arm-unknown-linux-musleabihf
armebv7r-none-eabi
armebv7r-none-eabihf
armv5te-unknown-linux-gnueabi
armv5te-unknown-linux-musleabi
armv7-linux-androideabi
armv7-unknown-linux-gnueabi
<span style="font-weight:700">armv7-unknown-linux-gnueabihf</span> &lt;— ARMv7 target
armv7-unknown-linux-musleabi
armv7-unknown-linux-musleabihf
armv7a-none-eabi
armv7r-none-eabi
armv7r-none-eabihf</pre></div><p>But we shall get back to Rust later, as we don’t even have a C compiler for our target for now.</p><h1 id="getting-a-cross-compiling-toolchain">Getting a cross-compiling toolchain</h1><h2 id="what-worked">What worked</h2><p>Since the compiler we need — a recent GCC with the right build flags — is not available, we can build one and package it as a Docker image so we can reuse it, both locally and in continuous integration pipelines. Getting a cross-compiling GCC toolchain working is a rather tedious task, which would need an entire blog post of its own. Fortunately, such blog posts already exist and are actually the solution to our toolchain problems: Paul Silisteanu’s excellent guide ”<a href="https://solarianprogrammer.com/2018/05/06/building-gcc-cross-compiler-raspberry-pi/">Building GCC as a cross compiler for the Raspberry Pi</a>” details how to build binutils, glibc and GCC 10 for the Raspberry Pi<sup><a href="#user-content-fn-actual-gcc10-build" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-actual-gcc10-build">4</a></sup>.</p><p>To ensure compatibility between our freshly-built cross-compiling toolchain and the target system, the build flags and versions of the various components (binutils, gcc and glibc) should match the ones in the actual system. On an up-to-date Raspberry Pi, you can check these using <code>dpkg</code> (assuming you installed the <code>build-essential</code> package for compiling native programs):</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">$ dpkg --list </span><span style="color:#ff79c6">|</span><span style="color:#f8f8f2"> grep -e gcc -e libc-bin -e binutils</span></span>
<span class="line"><span style="color:#f8f8f2">ii  binutils        2.35.2-2+rpi1            armhf        GNU assembler, linker and binary utilities</span></span>
<span class="line"><span style="color:#f8f8f2">[...]</span></span>
<span class="line"><span style="color:#f8f8f2">ii  gcc             4:10.2.1-1+rpi1          armhf        GNU C compiler</span></span>
<span class="line"><span style="color:#f8f8f2">[...]</span></span>
<span class="line"><span style="color:#f8f8f2">ii  libc-bin        2.31-13+rpt2+rpi1        armhf        GNU C Library: Binaries</span></span>
<span class="line"><span style="color:#f8f8f2">[...]</span></span></code></pre></div><p>Skipping over the <a href="https://github.com/vtavernier/cross-images/blob/a960a8fde182fcbf155a48e0785fd099b8997c58/targets/raspberrypi/Dockerfile">boring details</a> of building binutils 2.35/gcc 10.2/glibc 2.31, and packaging all this in a Docker image allows us to compile our first standalone binary for armv6 from an x86_64 machine:</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">$ docker run --rm -v </span><span style="color:#bd93f9">$PWD</span><span style="color:#f8f8f2">:/src vtavernier/cross:raspberrypi arm-linux-gnueabihf-gcc main.c</span></span>
<span class="line"><span style="color:#f8f8f2">$ readelf -A a.out</span></span>
<span class="line"><span style="color:#f8f8f2">[...]</span></span>
<span class="line"><span style="color:#f8f8f2">  Tag_CPU_name: </span><span style="color:#e9f284">&quot;</span><span style="color:#f1fa8c">6</span><span style="color:#e9f284">&quot;</span></span>
<span class="line"><span style="color:#f8f8f2">  Tag_CPU_arch: v6</span></span>
<span class="line"><span style="color:#f8f8f2">[...]</span></span></code></pre></div><h2 id="what-didnt-work">What didn’t work</h2><p>The previous section described the final (working) solution to the problem of getting an ARMv6 cross-compiler. I also tried various other options, without success:</p><ul><li><p>Using Raspbian’s gcc packages: since the <code>gcc-10</code> compiler works on Raspbian to produce ARMv6 binaries, it should be possible to take the corresponding <em>source package</em>, i.e. the source that generated the binary Debian packages, and <em>simply</em> compile it for the host architecture (x86_64). We could therefore keep all the patches, have the exact same version and flags as the target version of GCC.</p><p>This is close to not possible, for two reasons:</p><ul><li>Since none of Raspbian’s packages exist for <code>gcc-10</code> on x86_64, we would need to build x86_64-hosted versions of <em><strong>all</strong></em> the transitive dependencies of <code>gcc-10</code> to satisfy the build dependencies of the cross-compiler.</li><li>A cross-compiler package and a compiler package are very different things, at least in terms of Debian packages. Both <a href="https://salsa.debian.org/toolchain-team/gcc">GCC</a> and <a href="https://salsa.debian.org/toolchain-team/gcc-cross">Cross GCC</a> packages work on a tarball of GCC, but they configure it with different flags, install to different locations, produce different binary packages, etc. And all of this looks very mysterious if you have never been involved with GCC toolchain packaging — as it is my case.</li></ul><p>I didn’t pursue this way to the end, but it did seem like a dead-end early on. Please tell me in the comments if I’m wrong about this!</p></li><li><p>To benefit from the already available native toolchains, we could emulate the Raspberry Pi’s ARMv6 CPU using <a href="https://www.qemu.org/">QEMU</a>, and build inside this environment. This is what the <a href="https://www.balena.io/docs/reference/base-images/base-images/">Balena base images</a> enable, using the kernel’s <a href="https://en.wikipedia.org/wiki/Binfmt_misc">binfmt_misc</a> support and <a href="https://www.qemu.org/docs/master/user/index.html">QEMU User Mode Emulation</a>. The original Hyperion ambient lighting project uses this for continuous integration (see their <a href="https://github.com/hyperion-project/hyperion.docker-ci/blob/dec107c9cfd793163f0baef16ec1a8ed9196ab3b/armv6l">Dockerfiles</a>) and it seems to work pretty well except for two issues:</p><ul><li>It’s slow: ARMv6 code needs to be emulated and computation-intensive tasks like compiling Rust code heavily suffers from this. I would show a comparison using this post’s PoC, if it weren’t for the second issue:</li><li>It doesn’t work on 64-bit systems: QEMU User Mode Emulation works by translating system calls so the host kernel can handle them. However, some kernel APIs return word-sized values (64 bits on x86_64) which won’t fit on emulated user space structures for 32-bit architectures like ARMv6. This is a <a href="https://gitlab.com/qemu-project/qemu/-/issues/263">known bug</a>, and in case you encounter it, for example by compiling a Rust project, the error looks like this:<pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">    Updating crates.io index</span></span>
<span class="line"><span style="color:#f8f8f2">warning: spurious network error (2 tries remaining): could not read directory &#39;/root/.cargo/registry/index/github.com-1285ae84e5963aae/.git//refs&#39;: Value too large for defined data type; class=Os (2)</span></span>
<span class="line"><span style="color:#f8f8f2">warning: spurious network error (1 tries remaining): could not read directory &#39;/root/.cargo/registry/index/github.com-1285ae84e5963aae/.git//refs&#39;: Value too large for defined data type; class=Os (2)</span></span>
<span class="line"><span style="color:#f8f8f2">error: failed to get `color-eyre` as a dependency of package `blog-cross-rpi v0.1.0 (/blog-cross-rpi)`</span></span>
<span class="line"><span style="color:#f8f8f2"></span></span>
<span class="line"><span style="color:#f8f8f2">Caused by:</span></span>
<span class="line"><span style="color:#f8f8f2">  failed to fetch `https://github.com/rust-lang/crates.io-index`</span></span>
<span class="line"><span style="color:#f8f8f2"></span></span>
<span class="line"><span style="color:#f8f8f2">Caused by:</span></span>
<span class="line"><span style="color:#f8f8f2">  could not read directory &#39;/root/.cargo/registry/index/github.com-1285ae84e5963aae/.git//refs&#39;: Value too large for defined data type; class=Os (2)</span></span></code></pre>Note the <em>Value too large for defined data type</em>, which corresponds to the <code>EOVERFLOW</code> error mentioned in the QEMU issue tracker.</li></ul><p>Those images are still very useful for fetching dependencies and running simple tests (that don’t rely on unsupported system calls), as we will see in the next part.</p></li></ul><h1 id="dependencies-and-where-to-get-them">Dependencies and where to get them</h1><p>The next step once you have a working cross-compiler is to fetch the dependencies for the project you are compiling. We have multiple options:</p><table><thead><tr><th align="left">Method</th><th align="left">Pros</th><th align="left">Cons</th></tr></thead><tbody><tr><td align="left">Cross-compile all the dependencies</td><td align="left">Great opportunity to learn</td><td align="left">All transitive dependencies need to be recompiled, and that is going to take a while.</td></tr><tr><td align="left">Use Debian’s armhf packages</td><td align="left">Fully supported by <code>apt</code>/<code>dpkg</code>, binary packages available</td><td align="left">Debian armhf is ARMv7, linking to ARMv7 libraries results in an ARMv7 binary being created.</td></tr><tr><td align="left">Add Raspbian’s (armhf) repositories to <code>apt</code></td><td align="left">We get the exact packages for the target, still using <code>apt</code></td><td align="left">Raspbian’s packages are not <em>multiarch-aware</em><sup><a href="#user-content-fn-debian-multiarch" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-debian-multiarch">5</a></sup> since they are native packages, and can’t be installed at the same time. Also, postinst scripts are not supported since they only run on the native architecture for the package.</td></tr></tbody></table><p>In case you tried option #3, <code>apt install libpython3-dev</code> probably produced an error message looking like the following:</p><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">The following packages have unmet dependencies:</span></span>
<span class="line"><span style="color:#f8f8f2"> libexpat1:armhf : Depends: libc6:armhf (&gt;= 2.25) but it is not installable</span></span>
<span class="line"><span style="color:#f8f8f2">                   Depends: libgcc-s1:armhf (&gt;= 3.5) but it is not installable</span></span>
<span class="line"><span style="color:#f8f8f2"> libexpat1-dev:armhf : Depends: libc6-dev:armhf but it is not installable or</span></span>
<span class="line"><span style="color:#f8f8f2">                                libc-dev:armhf</span></span>
<span class="line"><span style="color:#f8f8f2"> libpython3.9:armhf : Depends: libpython3.9-stdlib:armhf (= 3.9.2-1+rpi1) but it is not installable</span></span>
<span class="line"><span style="color:#f8f8f2">                      Depends: libc6:armhf (&gt;= 2.29) but it is not installable</span></span>
<span class="line"><span style="color:#f8f8f2"> libpython3.9-dev:armhf : Depends: libpython3.9-stdlib:armhf (= 3.9.2-1+rpi1) but it is not installable</span></span>
<span class="line"><span style="color:#f8f8f2"> libsqlite3-0:armhf : Depends: libc6:armhf (&gt;= 2.29) but it is not installable</span></span>
<span class="line"><span style="color:#f8f8f2"> libsqlite3-dev:armhf : Depends: libc6-dev:armhf but it is not installable</span></span>
<span class="line"><span style="color:#f8f8f2"> zlib1g:armhf : Depends: libc6:armhf (&gt;= 2.4) but it is not installable</span></span>
<span class="line"><span style="color:#f8f8f2"> zlib1g-dev:armhf : Depends: libc6-dev:armhf but it is not installable or</span></span>
<span class="line"><span style="color:#f8f8f2">                             libc-dev:armhf</span></span>
<span class="line"><span style="color:#f8f8f2">E: Unable to correct problems, you have held broken packages.</span></span></code></pre><p>Following the dependency chain of <code>but it is not installable</code> packages does reveal <code>libc6:amd64</code> and <code>libc6:armhf</code> cannot be installed at the same time, since they are both native (and not <em>multiarch-aware</em>) packages, and thus install to the same location.</p><p>To solve this issue, we need to get the files for our dependencies and move them to a non-conflicting location. We can use the <a href="https://www.balena.io/docs/reference/base-images/base-images/">Balena base images</a> to do this:</p><ol><li>Run the <a href="https://hub.docker.com/r/balenalib/raspberry-pi-debian">Raspberry Pi image</a></li><li>Install the build dependencies using <code>apt-get update &amp;&amp; apt-get install -y libpython3-dev libsqlite3-dev</code></li><li>Copy <code>/usr/{include,lib,share}</code> into the cross-compiling root</li></ol><p>It’s convoluted, but <a href="https://github.com/vtavernier/cross-images/blob/a960a8fde182fcbf155a48e0785fd099b8997c58/targets/raspberrypi/Dockerfile#L90-L118">it works!</a>. You can link to the dependencies using <code>arm-linux-gnueabihf-gcc</code> and the right <code>-l/-L</code> flags, but that’s not what we are here for today…</p><h2 id="compiling-rust-code-with-cross">Compiling Rust code with <code>cross</code></h2><blockquote><p>“Zero setup” cross compilation and “cross testing” of Rust crates</p></blockquote><p>From the README of <a href="https://github.com/rust-embedded/cross">cross</a>.</p><p><code>cross</code> makes it easy to compile Rust for foreign architectures without having to install the (cross-)toolchains manually. For targets supported by cross, compiling is as easy as replacing this:</p><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">cargo build --target arm-unknown-linux-gnueabihf</span></span></code></pre><p>With this:</p><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">cross build --target arm-unknown-linux-gnueabihf</span></span></code></pre><p>When running <code>cross</code>, the following happens:</p><ul><li><code>cross</code> fetches the cross-building Docker image for the chosen target (either the <a href="https://github.com/rust-embedded/cross/tree/master/docker">default built-in</a>, or the one specified in <code>Cross.toml</code>)</li><li>Then, it bind-mounts <code>$CARGO_HOME</code> as <code>/cargo</code>, the project’s source as <code>/project</code> and the target dir as <code>/target</code> inside the container.</li><li>Finally, it runs <code>cargo</code> with the given flags inside the container</li></ul><p>The role of the Docker image is just to provide the cross-compiling tools along with the right environment variables that tell <code>cargo</code> which compilers and linkers to use for producing binaries for the target<sup><a href="#user-content-fn-cargo-env" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-cargo-env">6</a></sup>. If you wish to use the images built from all this, see <a href="https://github.com/vtavernier/cross-images/tree/a960a8fde182fcbf155a48e0785fd099b8997c58#usage">the usage instructions</a> from the companion repository to this post. Using these images makes cross-compiling <a href="https://github.com/vtavernier/blog-cross-rpi">the PoC</a> a breeze:</p><div class="drop-shadow-sm rounded-md tm-output" style="background-color:#282a36;color:var(--tw-prose-pre-code)"><div class="p-4 pb-1"><svg viewBox="0 0 54 14" height="14" width="54" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="6" cy="6" r="6" fill="#FF5F56" stroke="#E0443E" stroke-width=".5"></circle><circle cx="26" cy="6" r="6" fill="#FFBD2E" stroke="#DEA123" stroke-width=".5"></circle><circle cx="46" cy="6" r="6" fill="#27C93F" stroke="#1AAB29" stroke-width=".5"></circle></g></svg></div><pre class="astro-code" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#6272a4"># Get the code</span></span>
<span class="line"><span style="color:#f8f8f2">$ git clone https://github.com/vtavernier/blog-cross-rpi.git </span><span style="color:#ff79c6">&amp;&amp;</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">cd</span><span style="color:#f8f8f2"> blog-cross-rpi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># Build with all dependencies</span></span>
<span class="line"><span style="color:#f8f8f2">$ </span><span style="color:#ff79c6">export</span><span style="color:#f8f8f2"> ENABLE_PYO3=1</span></span>
<span class="line"><span style="color:#f8f8f2">$ cross build --target arm-unknown-linux-gnueabihf-gcc --all-features</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># Send the result to the target</span></span>
<span class="line"><span style="color:#f8f8f2">$ scp target/arm-linux-gnueabihf-gcc/debug/blog-cross-rpi pi@raspi-zero:</span><span style="color:#ff79c6">~</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># Run it</span></span>
<span class="line"><span style="color:#f8f8f2">$ ssh pi@raspi-zero ./blog-cross-rpi</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2><p>Building for the Raspberry Pi Zero was an interesting challenge and great learning experience. What worked in the end is the following:</p><ol><li>Build the same version of GCC/glibc as Raspbian</li><li>Use the Balena image for Raspberry Pi<sup><a href="#user-content-fn-balena-image-raspberry-pi" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-balena-image-raspberry-pi">7</a></sup> to fetch native dependencies</li><li>Copy the cross-compiler from step 1, the dependencies from step 2, set some environment variables</li><li>Use the resulting Docker image with <code>cross</code></li></ol><p>The images are available for use (see <a href="https://github.com/vtavernier/cross-images">the repository</a> for instructions) if you want to compile Rust code for the Raspberry Pi Zero… or you could just get a <a href="https://www.raspberrypi.com/products/raspberry-pi-zero-2-w/">Raspberry Pi Zero 2</a> for $5 more. Yes, it runs ARMv7 code, and yes, it came out while I was writing this piece. And since you are still reading this, you can probably guess which steps we can skip with this new board.</p><p>Until then, happy cross-compiling!</p><h2 id="references">References</h2><section class="footnotes" data-footnotes=""><h2 id="footnote-label" class="sr-only">Footnotes</h2><ol><li id="user-content-fn-osdev-target-triplets"><p><a href="https://wiki.osdev.org/Target_Triplet">https://wiki.osdev.org/Target_Triplet</a> <a href="#user-content-fnref-osdev-target-triplets" class="data-footnote-backref" aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id="user-content-fn-triplet-fullform"><p>This is the triplet in its full form, the extra <code>unknown</code> is the vendor, which can be omitted <a href="#user-content-fnref-triplet-fullform" class="data-footnote-backref" aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id="user-content-fn-naming-things"><p><a href="https://www.karlton.org/2017/12/naming-things-hard/">It’s a hard problem</a> <a href="#user-content-fnref-naming-things" class="data-footnote-backref" aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id="user-content-fn-actual-gcc10-build"><p>Paul’s post recommends building glibc 2.28 with GCC 8 because later versions of GCC would fail. Since I wanted to build for Raspbian Bullseye (the latest stable version of Raspbian), I managed to build glibc 2.31 with GCC 10.2.0 with only a few patches required, which was manageable. This also means we only need one cross-compiler, the one we’re targeting. <a href="#user-content-fnref-actual-gcc10-build" class="data-footnote-backref" aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id="user-content-fn-debian-multiarch"><p><a href="https://wiki.debian.org/Multiarch/HOWTO">https://wiki.debian.org/Multiarch/HOWTO</a> <a href="#user-content-fnref-debian-multiarch" class="data-footnote-backref" aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id="user-content-fn-cargo-env"><p>Variables such as <code>CC_&lt;target-triple&gt;</code> to specify what is the compiler for the LLVM target named <code>&lt;target-triple&gt;</code>. <a href="#user-content-fnref-cargo-env" class="data-footnote-backref" aria-label="Back to content" data-footnote-backref="">↩</a></p></li><li id="user-content-fn-balena-image-raspberry-pi"><p><a href="https://docker.io/balenalib/raspberry-pi-debian:bullseye-build">https://docker.io/balenalib/raspberry-pi-debian:bullseye-build</a> <a href="#user-content-fnref-balena-image-raspberry-pi" class="data-footnote-backref" aria-label="Back to content" data-footnote-backref="">↩</a></p></li></ol></section></div><div class="flex flex-col justify-between max-w-3xl mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class="mr-5"><li class="inline-block bg-gray-100 dark:bg-zinc-700 font-medium lowercase mb-2 mr-2 px-2 py-0.5"><a href="/pr-preview/pr-5/tags/cross-compiling/" class="text-muted dark:hover:text-gray-200 dark:text-zinc-300 hover:text-primary">cross-compiling</a></li><li class="inline-block bg-gray-100 dark:bg-zinc-700 font-medium lowercase mb-2 mr-2 px-2 py-0.5"><a href="/pr-preview/pr-5/tags/rust/" class="text-muted dark:hover:text-gray-200 dark:text-zinc-300 hover:text-primary">rust</a></li><li class="inline-block bg-gray-100 dark:bg-zinc-700 font-medium lowercase mb-2 mr-2 px-2 py-0.5"><a href="/pr-preview/pr-5/tags/c/" class="text-muted dark:hover:text-gray-200 dark:text-zinc-300 hover:text-primary">c</a></li></ul><div class="text-gray-500 align-middle dark:text-zinc-600 mt-5 sm:mt-1"><span class="text-gray-400 align-super dark:text-zinc-400 font-bold">Share:</span> <button class="ml-2" data-aw-social-share="twitter" data-aw-url="https://vtavernier.github.io/pr-preview/pr-5/posts/i-tried-cross-compiling/" title="Twitter Share" data-aw-text="I tried cross-compiling for the Raspberry Pi"><svg viewBox="0 0 24 24" class="h-6 w-6 dark:hover:text-zinc-300 dark:text-zinc-500 hover:text-black text-gray-400" astro-icon="ri:twitter-fill"><path d="M22.162 5.656a8.384 8.384 0 0 1-2.402.658A4.196 4.196 0 0 0 21.6 4c-.82.488-1.719.83-2.656 1.015a4.182 4.182 0 0 0-7.126 3.814 11.874 11.874 0 0 1-8.62-4.37 4.168 4.168 0 0 0-.566 2.103c0 1.45.738 2.731 1.86 3.481a4.168 4.168 0 0 1-1.894-.523v.052a4.185 4.185 0 0 0 3.355 4.101 4.21 4.21 0 0 1-1.89.072A4.185 4.185 0 0 0 7.97 16.65a8.394 8.394 0 0 1-6.191 1.732 11.83 11.83 0 0 0 6.41 1.88c7.693 0 11.9-6.373 11.9-11.9 0-.18-.005-.362-.013-.54a8.496 8.496 0 0 0 2.087-2.165z" fill="currentColor"/></svg></button> <button class="ml-2" data-aw-social-share="facebook" data-aw-url="https://vtavernier.github.io/pr-preview/pr-5/posts/i-tried-cross-compiling/" title="Facebook Share"><svg viewBox="0 0 24 24" class="h-6 w-6 dark:hover:text-zinc-300 dark:text-zinc-500 hover:text-black text-gray-400" astro-icon="ri:facebook-box-fill"><path d="M15.402 21v-6.966h2.333l.349-2.708h-2.682V9.598c0-.784.218-1.319 1.342-1.319h1.434V5.857a19.19 19.19 0 0 0-2.09-.107c-2.067 0-3.482 1.262-3.482 3.58v1.996h-2.338v2.708h2.338V21H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1h-4.598z" fill="currentColor"/></svg></button> <button class="ml-2" data-aw-social-share="linkedin" data-aw-url="https://vtavernier.github.io/pr-preview/pr-5/posts/i-tried-cross-compiling/" title="Linkedin Share" data-aw-text="I tried cross-compiling for the Raspberry Pi"><svg viewBox="0 0 24 24" class="h-6 w-6 dark:hover:text-zinc-300 dark:text-zinc-500 hover:text-black text-gray-400" astro-icon="ri:linkedin-box-fill"><path d="M18.335 18.339H15.67v-4.177c0-.996-.02-2.278-1.39-2.278-1.389 0-1.601 1.084-1.601 2.205v4.25h-2.666V9.75h2.56v1.17h.035c.358-.674 1.228-1.387 2.528-1.387 2.7 0 3.2 1.778 3.2 4.091v4.715zM7.003 8.575a1.546 1.546 0 0 1-1.548-1.549 1.548 1.548 0 1 1 1.547 1.549zm1.336 9.764H5.666V9.75H8.34v8.589zM19.67 3H4.329C3.593 3 3 3.58 3 4.297v15.406C3 20.42 3.594 21 4.328 21h15.338C20.4 21 21 20.42 21 19.703V4.297C21 3.58 20.4 3 19.666 3h.003z" fill="currentColor"/></svg></button> <button class="ml-2" data-aw-social-share="mail" data-aw-url="https://vtavernier.github.io/pr-preview/pr-5/posts/i-tried-cross-compiling/" title="Email Share" data-aw-text="I tried cross-compiling for the Raspberry Pi"><svg viewBox="0 0 24 24" class="h-6 w-6 dark:hover:text-zinc-300 dark:text-zinc-500 hover:text-black text-gray-400" astro-icon="ri:mail-fill"><path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm9.06 8.683L5.648 6.238 4.353 7.762l7.72 6.555 7.581-6.56-1.308-1.513-6.285 5.439z" fill="currentColor"/></svg></button></div></div></article></section><div data-issue-term="pathname" data-label="comments" data-repo="vtavernier/vtavernier.github.io" data-theme="github-dark" id="utterances-container"></div><div class="mx-auto sm:px-6 max-w-3xl px-6 md:pb-20 md:pt-4 pb-12 pt-8"><a href="/pr-preview/pr-5/posts/" class="btn btn-ghost md:px-3 px-3"><svg viewBox="0 0 24 24" class="h-5 w-5 -ml-1.5 mr-1" astro-icon="tabler:chevron-left"><path d="m15 6-6 6 6 6" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg> Back to Blog</a></div></main><footer class="border-gray-200 border-t dark:border-zinc-800 relative"><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden="true"></div><div class="mx-auto sm:px-6 px-4 dark:text-zinc-300 max-w-7xl relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="flex md:mb-0 -ml-2 mb-4 md:ml-4 md:order-1"><li><a href="mailto:v.tavernier@pm.me" class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label="E-mail"><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon="tabler:mail"><g fill="none" class="icon-tabler" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><rect height="14" rx="2" width="18" x="3" y="5"/><path d="m3 7 9 6 9-6"/></g></svg></a></li><li><a href="https://github.com/vtavernier" class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label="Github"><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon="tabler:brand-github"><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6 0 0 0-1.3-3.2 4.2 4.2 0 0 0-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3 0 0 0-6.2 0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2 0 0 0-.1 3.2A4.6 4.6 0 0 0 4 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg></a></li><li><a href="https://www.linkedin.com/in/vincent-tavernier-707b5012a/" class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label="LinkedIn"><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon="tabler:brand-linkedin"><g fill="none" class="icon-tabler" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><rect height="16" rx="2" width="16" x="4" y="4"/><path d="M8 11v5M8 8v.01M12 16v-5M16 16v-3a2 2 0 0 0-4 0"/></g></svg></a></li><li><a href="https://crates.io/users/vtavernier" class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label="crates.io"><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon="tabler:package"><g fill="none" class="icon-tabler" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="m12 3 8 4.5v9L12 21l-8-4.5v-9L12 3M12 12l8-4.5M12 12v9M12 12 4 7.5M16 5.25l-8 4.5"/></g></svg></a></li><li><a href="/pr-preview/pr-5/rss.xml" class="items-center inline-flex dark:focus:ring-gray-700 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 p-2.5 rounded-lg text-sm text-muted dark:hover:bg-zinc-700 hover:bg-zinc-100" aria-label="RSS"><svg viewBox="0 0 24 24" class="h-5 w-5" astro-icon="tabler:rss"><g fill="none" class="icon-tabler" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"/></g></svg></a></li></ul><div class="mr-4 dark:text-zinc-400 text-sm">© 2019 ‒ 2023 Vincent Tavernier · All written content licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license"><abbr title="Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)">CC BY-NC-SA 4.0</abbr></a> unless otherwise specified · Blog theme based on <a href="https://github.com/onwidget/astrowind" class="items-center inline-flex" rel="external" target="_blank">AstroWind <svg viewBox="0 0 24 24" class="inline-block h-4 w-4 mx-1" astro-icon="tabler:external-link"><g fill="none" class="icon-tabler" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M11 7H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-5M10 14 20 4M15 4h5v5"/></g></svg></a></div></div></div></footer><script type="module">import mermaid from"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";mermaid.initialize({startOnLoad:!0,theme:"dark"})</script><script>!function(){const e="dark:only";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function a(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light")})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),a=encodeURIComponent(t.getAttribute("data-aw-text"));let c;switch(o){case"facebook":c=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":c=`https://twitter.com/intent/tweet?url=${n}&text=${a}`;break;case"linkedin":c=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${a}`;break;case"whatsapp":c=`https://wa.me/?text=${a}%20${n}`;break;case"mail":c=`mailto:?subject=%22${a}%22&body=${a}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=c,s.click()})),a(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{a()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>